<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beehire â€” Worker Profile</title>

  <!-- Corporate font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#FFC107;          /* honey gold */
      --ink:#0E2A32;            /* deep navy */
      --muted:#6B7B84;
      --bg:#F6F9FC;
      --card:#ffffff;
      --line:#E6EDF2; --line-strong:#D7E1EA;
      --focus:#2C7BE5;
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#fff 0%, var(--bg) 70%); color:var(--ink);
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:40;
      background:var(--card); border-bottom:1px solid var(--line);
      box-shadow:0 2px 10px rgba(14,42,50,.04);
    }
    .nav{
      max-width:1100px; margin:0 auto; padding:14px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:12px; text-decoration:none}
    .brand-logo{width:42px; height:42px; object-fit:contain; filter:drop-shadow(0 2px 8px rgba(0,0,0,.06))}
    .brand-title{display:flex; flex-direction:column; line-height:1.1}
    .brand-title .name{font-weight:800; font-size:1.12rem; color:var(--ink)}
    .brand-title .tag{font-size:.8rem; color:var(--muted); font-weight:700; letter-spacing:.3px}

    /* Layout */
    .profile-wrapper{
      max-width:1100px; margin:26px auto 100px; padding:0 20px;
      display:grid; grid-template-columns:320px 1fr; gap:26px;
    }
    @media (max-width: 900px){ .profile-wrapper{ grid-template-columns:1fr } }

    .sidebar{
      background:var(--card); border:1px solid var(--line); border-radius:16px; padding:22px; text-align:center;
      box-shadow:0 10px 24px rgba(14,42,50,.06);
    }
    .sidebar img{
      width:160px; height:160px; border-radius:50%;
      border:4px solid var(--brand); object-fit:cover; background:#fff;
      box-shadow:0 6px 16px rgba(14,42,50,.08);
    }
    .meta{margin:6px 0 0; color:var(--muted)}

    .verified-badge{
      color:#fff; padding:6px 12px; border-radius:999px; font-size:.85rem; font-weight:800; display:inline-block; margin-top:10px;
      background:#9ca3af;
    }
    .progress-bar{ margin-top:10px; background:#f1f5f9; border-radius:999px; height:18px; overflow:hidden; border:1px solid var(--line); }
    .progress-fill{
      height:100%; background:linear-gradient(90deg,#f59e0b,#fbbf24,#84cc16);
      width:0; line-height:18px; text-align:center; font-size:.78rem; font-weight:800; color:#111;
      transition: width .25s ease;
    }

    .contact-buttons{
      margin-top:16px; display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .btn{
      width:100%; padding:12px; border-radius:12px; cursor:pointer; font-weight:800; font-size:.95rem;
      background:#fff; border:1px solid var(--line-strong); color:var(--ink);
      transition: box-shadow .15s, border-color .15s, transform .06s ease-in;
    }
    .btn:hover{ border-color:var(--focus); box-shadow:0 6px 16px rgba(14,42,50,.08) }
    .btn:active{ transform: translateY(1px) }

    .main-content{ display:flex; flex-direction:column; gap:18px; }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:16px; padding:22px;
      box-shadow:0 10px 24px rgba(14,42,50,.06);
    }
    .card h3{
      margin:0 0 10px; color:var(--ink); font-size:1.05rem;
      padding-bottom:8px; border-bottom:1px dashed var(--line-strong);
    }
    .skill-badge{
      display:inline-block; background:#FFF6D6; color:#7A5B00; padding:6px 12px; border-radius:999px; margin:5px; font-size:.85rem; font-weight:800; border:1px solid #F3D66A;
    }

    .document-list{ list-style:none; padding-left:0; margin:0 }
    .document-list li{
      background:#fbfdff; padding:12px; border-radius:12px; margin-bottom:10px; border:1px solid var(--line);
      display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap:wrap;
    }
    .document-list .actions{ display:flex; gap:8px; align-items:center; }
    .document-list button{ background:#fff; border:1px solid var(--line-strong); padding:8px 12px; border-radius:10px; cursor:pointer; font-size:.9rem; font-weight:800; color:var(--ink) }
    .document-list button:hover{ border-color:var(--focus); box-shadow:0 6px 16px rgba(14,42,50,.06) }
    .open-new{ text-decoration:none; font-weight:800; color:#0D6EFD }
    .open-new[aria-disabled="true"]{ color:#9aa7b1; pointer-events:none }

    .small-muted{ font-size:.85rem; color:var(--muted) }

    /* Bottom action bar */
    .actionbar{
      position:fixed; bottom:0; left:0; right:0;
      background:rgba(255,255,255,.9); backdrop-filter:blur(6px);
      border-top:1px solid var(--line); padding:12px 20px; display:flex; justify-content:center; z-index:50;
    }
    .actionbar .btn-primary{
      min-width:220px; background:var(--brand); border:1px solid var(--brand); color:#111; border-radius:12px; font-weight:800;
      box-shadow:0 8px 20px rgba(255,193,7,.28);
      transition:filter .15s, box-shadow .15s, transform .06s;
    }
    .actionbar .btn-primary:hover{ filter:brightness(.98); box-shadow:0 12px 26px rgba(255,193,7,.38) }
    .actionbar .btn-primary:active{ transform:translateY(1px) }

    /* Modal */
    .modal{ display:none; position:fixed; z-index:9999; inset:0; background-color:rgba(0,0,0,0.85); }
    .modal-content{ margin:40px auto; width:min(1000px,90%); height:min(85vh,900px); background:#fff; border-radius:14px; overflow:hidden; display:flex; flex-direction:column; }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--line); }
    .modal-body{ position:relative; flex:1; overflow:auto; background:#0b0b0b; display:flex; align-items:center; justify-content:center; }
    .modal-body embed, .modal-body img{ max-width:100%; max-height:100%; width:100%; height:100%; object-fit:contain; background:#0b0b0b; }
    .close{ color:#111; font-size:22px; font-weight:800; cursor:pointer; border:0; background:transparent; }
    .close:hover{ color:#dc2626; }
    .watermark{
      position:absolute; top:40%; left:10%; transform:rotate(-25deg);
      font-size:28px; color:rgba(230,230,230,.25); font-weight:800; white-space:nowrap; pointer-events:none;
    }

    /* Focus ring */
    button:focus, a:focus{ outline:none; box-shadow:0 0 0 3px rgba(44,123,229,.2) }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="nav">
      <a class="brand" href="beehiremain.html">
        <img class="brand-logo" src="BeeHire Logo.png" alt="Beehire logo">
        <span class="brand-title">
          <span class="name">Beehire CONNECT</span>
          <span class="tag">Worker Profile</span>
        </span>
      </a>
      <span style="padding:6px 10px; border:1px solid var(--line-strong); border-radius:999px; font-weight:800; font-size:.8rem; background:#fff; color:var(--ink)">Profile Viewer</span>
    </div>
  </header>

  <div class="profile-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
      <img id="profilePhoto" src="images/profile_placeholder.png" alt="Profile Photo">
      <h2 id="workerName" style="margin:12px 0 6px">â€”</h2>
      <p class="meta"><span id="skillCategory">â€”</span> â€¢ <span id="locationText">â€”</span></p>

      <span class="verified-badge" id="verifiedBadge">Not Verified</span>
      <div class="progress-bar" aria-hidden="true">
        <div class="progress-fill" id="progressFill">Not Verified</div>
      </div>

      <div class="contact-buttons">
        <button class="btn" id="callBtn">Call</button>
        <button class="btn" id="msgBtn">Message</button>
      </div>
    </aside>

    <!-- Main Content -->
    <section class="main-content">
      <div class="card">
        <h3>Personal Information</h3>
        <p><b>Age:</b> <span id="ageTxt">â€”</span></p>
        <p><b>Gender:</b> <span id="genderTxt">â€”</span></p>
        <p><b>Civil Status:</b> <span id="statusTxt">â€”</span></p>
        <p><b>Email:</b> <span id="emailTxt">â€”</span></p>
        <p><b>Phone:</b> <span id="phoneTxt">â€”</span></p>
        <p><b>Location:</b> <span id="locationPI">â€”</span></p>
      </div>

      <div class="card">
        <h3>About Me</h3>
        <p id="bioTxt">â€”</p>
      </div>

      <div class="card">
        <h3>Skills</h3>
        <div id="skillsWrap"><!-- populated from Firestore --></div>
      </div>

      <div class="card">
        <h3>Service Details</h3>
        <p><b>Rate:</b> <span id="rateTxt">â€”</span></p>
        <p><b>Availability:</b> <span id="availTxt">â€”</span></p>
      </div>

      <div class="card">
        <h3>Uploaded Documents</h3>
        <ul class="document-list" id="docList">
          <!-- Neutral defaults; Firebase will append/replace -->
          <li>
            ðŸ“„ Valid ID
            <div class="actions">
              <button onclick="window.openDoc('docs/id.pdf','Valid ID')">View</button>
              <a class="open-new" href="docs/id.pdf" target="_blank" rel="noopener">Open â†—</a>
            </div>
          </li>
        </ul>
        <div class="small-muted">Note: Images open inline; PDFs open in a viewer. Public links onlyâ€”use Firebase rules for real security.</div>
      </div>
    </section>
  </div>

  <!-- Bottom Edit Profile action -->
  <div class="actionbar">
    <button class="btn-primary" id="editBtn">Edit Profile</button>
  </div>

  <!-- Modal -->
  <div id="docModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="docTitle">
    <div class="modal-content">
      <div class="modal-header">
        <strong id="docTitle">Document</strong>
        <button class="close" id="closeBtn" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="watermark" id="dynamicWatermark"></div>
        <embed id="docPdf" src="" type="application/pdf" style="display:none;">
        <img id="docImg" src="" alt="Document" style="display:none;">
      </div>
    </div>
  </div>

  <!-- Non-module: modal + light protections -->
  <script>
    // Open doc (PDF or image)
    window.openDoc = function(url, title, workerName, workerEmail){
      const safe = url?.startsWith("http://") ? url.replace("http://","https://") : (url||"");
      const isPdf = /\.pdf(\?|#|$)/i.test(safe);
      document.getElementById("docTitle").textContent = title || "Document";
      document.getElementById("docPdf").style.display = isPdf ? "block" : "none";
      document.getElementById("docImg").style.display = isPdf ? "none"  : "block";
      document.getElementById(isPdf ? "docPdf" : "docImg").src = safe;

      const name = (workerName || document.getElementById("workerName").textContent || "Beehire Worker").trim();
      const email= (workerEmail || document.getElementById("emailTxt").textContent || "").trim();
      document.getElementById("dynamicWatermark").textContent = `${name}${email ? " | " + email : ""} â€” Beehire Verified Document`;

      document.getElementById("docModal").style.display = "block";
    };
    function closeModal(){
      document.getElementById("docModal").style.display = "none";
      document.getElementById("docPdf").src = ""; document.getElementById("docImg").src = "";
    }
    document.getElementById("closeBtn").addEventListener("click", closeModal);
    window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    // Light content protection (bypassable; rely on Storage rules)
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => { if (e.ctrlKey && e.key.toLowerCase()==='p'){ e.preventDefault(); alert("Printing disabled."); } });

    // Actions
    document.getElementById('callBtn').onclick = () => {
      const phone = document.getElementById('phoneTxt').textContent.trim();
      phone ? (window.location.href = `tel:${phone}`) : alert("No phone number available.");
    };
    document.getElementById('msgBtn').onclick  = () => {
      const name = document.getElementById('workerName').textContent.trim();
      window.location.href = `chat.html?name=${encodeURIComponent(name)}`;
    };
    document.getElementById('editBtn').onclick = () => { window.location.href = "edit_profile.html"; };
  </script>

  <!-- Firebase: fetch details + docs + verification -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkkVvflDza_lmFmUmsgUQv6iOiMW3y9bc",
        authDomain: "myapp-96865.firebaseapp.com",
        databaseURL: "https://myapp-96865-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "myapp-96865",
        // If Storage misbehaves, try: "myapp-96865.appspot.com"
        storageBucket: "myapp-96865.firebasestorage.app",
        messagingSenderId: "217431866794",
        appId: "1:217431866794:web:965d02cc01d12ae555ffd3",
        measurementId: "G-1T4M9PE1GD"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const toHttps = (u)=>!u ? "" : (u.startsWith("http://") ? u.replace("http://","https://") : u);
    const money = (v)=>!v ? "" : (/^\d+(\.\d+)?$/.test(v) ? `â‚±${v} per hour` : v);
    const urlUid = new URLSearchParams(location.search).get("uid");

    function setBadge(status){
      const el = $("verifiedBadge");
      const map = { 'Verified':'#16a34a', 'Pending Review':'#d97706', 'Not Verified':'#9ca3af', 'Rejected':'#dc2626' };
      el.textContent = status; el.style.background = map[status] || '#9ca3af';
    }
    function setProgress(status){
      const fill = $("progressFill");
      const pct = { 'Not Verified':0, 'Pending Review':75, 'Verified':100, 'Rejected':0 }[status] ?? 0;
      fill.style.width = pct + '%'; fill.textContent = status;
    }
    function computeVerificationStatus(data, docsCount){
      const raw = (data?.verificationStatus || '').toString().trim().toLowerCase();
      if (raw){
        if (raw==='verified' || raw==='approved') return 'Verified';
        if (raw==='pending' || raw==='in review' || raw==='review' || raw==='under review') return 'Pending Review';
        if (raw==='rejected' || raw==='declined') return 'Rejected';
        if (raw==='unverified') return 'Not Verified';
      }
      if (data?.verified === true) return 'Verified';
      if (docsCount > 0) return 'Pending Review';
      return 'Not Verified';
    }
    function applyVerificationUI(status){ setBadge(status); setProgress(status); }

    async function appendDocs(uid, data){
      const list = $("docList");
      // clear auto placeholders except first sample item
      list.querySelectorAll("li:not(:first-child)").forEach(li => li.remove());

      // top-level array or subcollection fallback
      let docs = [];
      if (Array.isArray(data?.documents)) {
        docs = data.documents.filter(d=>d && d.url);
      } else {
        const sub = await getDocs(collection(doc(db,"workers",uid),"documents"));
        docs = sub.docs.map(d=>d.data()).filter(d=>d && d.url);
      }

      const existingNames = new Set([...list.querySelectorAll('li')].map(li=>li.firstChild?.textContent?.trim() || ""));
      docs.forEach(d=>{
        const url = toHttps(d.url);
        const name = `ðŸ“„ ${d.name || "Document"}`;
        // skip if already present
        if ([...existingNames].some(t=>t.includes(d.name || "Document"))) return;

        const li = document.createElement("li");
        li.innerHTML = `
          ${name}
          <div class="actions">
            <button ${url ? "" : "disabled"}>View</button>
            <a class="open-new" ${url ? `href="${url}"` : ""} target="_blank" rel="noopener" ${url ? "" : 'aria-disabled="true"'}>Open â†—</a>
          </div>`;
        const btn = li.querySelector("button");
        if (url) btn.onclick = ()=> window.openDoc(url, d.name || "Document", data?.fullName || "", data?.email || "");
        list.appendChild(li);
      });

      // finalize status
      applyVerificationUI(computeVerificationStatus(data, docs.length));
    }

    async function loadProfile(uid){
      const ref = doc(db,"workers",uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) { applyVerificationUI('Not Verified'); return; }

      const d = snap.data();

      $("workerName").textContent = d.fullName || d.name || d.username || "â€”";
      $("skillCategory").textContent = d.skillCategory || (Array.isArray(d.skills) && d.skills[0]) || "â€”";
      $("locationText").textContent = d.location || "â€”";
      $("locationPI").textContent   = d.location || "â€”";

      const img = toHttps(d.profileImageUrl || d.photoUrl);
      $("profilePhoto").src = img || "images/profile_placeholder.png";

      $("ageTxt").textContent    = (typeof d.age === "number") ? d.age : "â€”";
      $("genderTxt").textContent = d.gender || "â€”";
      $("statusTxt").textContent = d.status || "â€”";
      $("emailTxt").textContent  = d.email  || "â€”";
      $("phoneTxt").textContent  = d.phone  || "â€”";

      $("bioTxt").textContent = d.bio || "â€”";

      // skills
      const wrap = $("skillsWrap"); wrap.innerHTML = "";
      if (Array.isArray(d.skills) && d.skills.length){
        d.skills.forEach(s=>{
          const span = document.createElement("span");
          span.className = "skill-badge";
          span.textContent = s;
          wrap.appendChild(span);
        });
      }

      $("rateTxt").textContent  = d.pricing ? money(d.pricing) : "â€”";
      $("availTxt").textContent = d.availability || "â€”";

      // initial status before docs
      applyVerificationUI(computeVerificationStatus(d, 0));

      // docs + finalize status
      await appendDocs(uid, d);
    }

    onAuthStateChanged(auth, async (user)=>{
      const targetUid = urlUid || (user && user.uid);
      if (targetUid) await loadProfile(targetUid);
      else applyVerificationUI('Not Verified');
    });
  </script>
</body>
</html>
