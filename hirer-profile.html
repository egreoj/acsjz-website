<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Beehire ‚Äî Hirer Verification</title>

<!-- Corporate font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --brand:#FFC107;           /* corporate honey gold */
    --brand-ink:#0E2A32;       /* deep navy */
    --ink:#0E2A32;
    --muted:#6B7B84;
    --bg:#F6F9FC;              /* cleaner, corporate background */
    --card:#ffffff;
    --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    --line:#E6EDF2; --line-strong:#D7E1EA;
    --focus:#2C7BE5;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
    margin:0; background:linear-gradient(180deg,#FFFFFF 0%, var(--bg) 70%);
    color:var(--ink);
  }

  /* Header */
  header{
    position:sticky; top:0; z-index:50;
    background:var(--card);
    border-bottom:1px solid var(--line);
    box-shadow:0 2px 10px rgba(14,42,50,.04);
  }
  .nav{
    max-width:1100px; margin:0 auto; padding:12px 18px;
    display:flex; align-items:center; justify-content:space-between; gap:16px;
  }
  .brand{display:flex; align-items:center; gap:12px; text-decoration:none}
  .brand-logo{width:42px; height:42px; object-fit:contain; filter:drop-shadow(0 2px 8px rgba(0,0,0,.06))}
  .brand-title{display:flex; flex-direction:column; line-height:1.1}
  .brand-title .name{font-weight:800; font-size:1.1rem; color:var(--brand-ink); letter-spacing:.2px}
  .brand-title .tag{font-size:.78rem; color:var(--muted); font-weight:700; letter-spacing:.3px}

  .status{display:flex; align-items:center; gap:10px; color:var(--muted); font-weight:700;}
  .badge{
    padding:6px 10px; border-radius:999px; font-weight:800; font-size:.85rem;
    border:1px solid var(--line-strong); background:#fff; color:var(--brand-ink);
  }
  .b-verified{background:#dcfce7;color:#166534;border-color:#86efac}
  .b-pending{background:#fffbeb;color:#92400e;border-color:#fde68a}
  .b-incomplete{background:#fef2f2;color:#991b1b;border-color:#fecaca}

  /* Main */
  main{max-width:1100px; margin:28px auto 100px; padding:0 18px}
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:16px;
    box-shadow:0 10px 24px rgba(14,42,50,.06);
    margin-bottom:16px; overflow:hidden;
  }
  .card h2{
    margin:0; padding:16px 18px; border-bottom:1px solid var(--line);
    font-size:1.1rem; letter-spacing:.2px; display:flex; align-items:center; gap:10px;
  }
  .card h2 .sec-dot{width:8px; height:8px; border-radius:2px; background:var(--brand)}
  .card .body{padding:18px}

  .grid{display:grid; gap:14px; grid-template-columns:repeat(12,1fr)}
  .col-12{grid-column:span 12}
  .col-6{grid-column:span 12}
  @media(min-width:720px){ .col-6{grid-column:span 6} }

  label{font-weight:800; font-size:.92rem; margin-bottom:6px; display:block; color:var(--brand-ink)}
  input,select,textarea{
    width:100%; padding:11px 12px; border:1px solid var(--line-strong);
    border-radius:12px; font-size:1rem; background:#fff; color:var(--ink);
    transition:border-color .15s, box-shadow .15s, background .15s;
  }
  input:hover,select:hover,textarea:hover{ background:#FCFEFF }
  input:focus,select:focus,textarea:focus{
    outline:none; border-color:var(--focus); box-shadow:0 0 0 3px rgba(44,123,229,.15)
  }
  textarea{min-height:90px; resize:vertical}

  .muted{color:var(--muted); font-size:.9rem}
  .hint{font-size:.9rem; color:#4b5563; margin-top:6px}

  /* sticky actions bar */
  .actions{
    display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    padding:16px; border-top:1px solid var(--line); position:sticky; bottom:0;
    background:rgba(255,255,255,.92); backdrop-filter:saturate(160%) blur(6px);
    z-index:10;
  }
  button{border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer}
  .btn{
    background:var(--brand); color:#111;
    box-shadow:0 8px 20px rgba(255,193,7,.28); transition:transform .06s, box-shadow .15s, filter .15s;
  }
  .btn:hover{filter:brightness(.98); box-shadow:0 12px 26px rgba(255,193,7,.38)}
  .btn:active{transform:translateY(1px)}
  .btn-ghost{background:#fff; border:1px solid var(--line-strong); color:var(--brand-ink);}
  .btn-ghost:hover{box-shadow:0 8px 20px rgba(14,42,50,.05)}

  .warn{background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; border-radius:12px; padding:12px 14px; margin-bottom:14px}
  .success{background:#ecfeff; border:1px solid #a5f3fc; color:#075985; border-radius:12px; padding:12px 14px; margin-bottom:14px}

  /* completeness meter */
  .kv{display:flex; gap:10px; align-items:center}
  .kv .dot{width:10px; height:10px; border-radius:2px}
  .dot.ok{background:var(--ok)} .dot.mid{background:#f59e0b} .dot.bad{background:var(--bad)}
  .meter{height:10px; background:#f1f5f9; border-radius:999px; overflow:hidden; margin-top:8px}
  .meter > span{display:block; height:100%; background:linear-gradient(90deg,#f97316,#f59e0b,#84cc16)}

  .file-note{font-size:.85rem; color:#555; margin-top:6px}
  .hide{display:none !important}
  .readonly-note{background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46; padding:10px 12px; border-radius:10px; margin:12px 18px}

  /* avatar */
  .avatar-wrap{display:flex; align-items:center; gap:16px}
  .avatar{
    width:84px; height:84px; border-radius:50%; border:3px solid var(--brand);
    object-fit:cover; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.08)
  }

  /* Upload UI (same vibe as worker) */
  .upload-row{display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap}
  .btn-mini{padding:8px 12px; font-size:.9rem; border-radius:10px}
  .pill{border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:.85rem}
  .pill.ok{background:#dcfce7; color:#166534; border-color:#86efac}
  .pill.warn{background:#fffbeb; color:#92400e; border-color:#fde68a}
  .pill.bad{background:#fef2f2; color:#991b1b; border-color:#fecaca}
  .bar{width:160px; height:10px; background:#f1f5f9; border-radius:999px; overflow:hidden}
  .bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#34d399); transition:width .15s}
</style>
</head>
<body>

<header>
  <div class="nav">
    <a class="brand" href="#">
      <img class="brand-logo" src="BeeHire Logo.png" alt="Beehire logo">
      <span class="brand-title">
        <span class="name">Beehire</span>
        <span class="tag">Hirer Verification</span>
      </span>
    </a>
    <div class="status">
      <span>Status:</span>
      <span id="statusBadge" class="badge b-incomplete">Not Verified</span>
    </div>
  </div>
</header>

<main>
  <div id="alertBox" class="warn" style="display:none"></div>
  <div id="okBox" class="success" style="display:none"></div>
  <div id="readonlyNote" class="readonly-note hide">‚úÖ Verified profile ‚Äî read-only. Contact support or an admin to make changes.</div>

  <!-- Completeness -->
  <div class="card">
    <h2><span class="sec-dot"></span> Profile Completeness</h2>
    <div class="body">
      <div class="kv" style="justify-content:space-between">
        <div class="kv"><span class="dot bad" id="meterDot"></span> <span id="meterLabel" class="muted">Incomplete</span></div>
        <div class="muted"><span id="meterPct">0%</span> complete</div>
      </div>
      <div class="meter" aria-hidden="true"><span id="meterBar" style="width:0%"></span></div>
      <p class="hint">
        Target <b>100%</b>: Basic + Address + <b>two IDs (ID Front + Selfie)</b>.<br>
        <b>Business/Social Proof</b> adds <b>+10%</b> bonus. Add at least one <b>Reference</b> for another <b>+10%</b> (can reach 110%).
      </p>
    </div>
  </div>

  <!-- BASIC -->
  <form id="form">
  <div class="card">
    <h2><span class="sec-dot"></span> Basic Information</h2>
    <div class="body grid">
      <div class="col-12">
        <label>Profile Photo</label>
        <div class="avatar-wrap">
          <img id="avatarPreview" class="avatar" alt="Profile">
          <input id="profilePhoto" type="file" accept="image/*" class="upload-control">
        </div>
        <div class="file-note">Tip: Clear front-facing photo (JPEG/PNG).</div>
      </div>

      <div class="col-6">
        <label for="fullName">Full Name (as per ID)</label>
        <input id="fullName" placeholder="Juan D. Dela Cruz">
      </div>
      <div class="col-6">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="juan@email.com">
      </div>
      <div class="col-6">
        <label for="phone">Phone</label>
        <input id="phone" placeholder="+63 9xx xxx xxxx">
      </div>
      <div class="col-6">
        <label for="role">Role</label>
        <input id="role" value="hirer" disabled>
      </div>
    </div>
  </div>

  <!-- ADDRESS -->
  <div class="card">
    <h2><span class="sec-dot"></span> Address</h2>
    <div class="body grid">
      <div class="col-12">
        <label for="address1">Address Line</label>
        <input id="address1" placeholder="House/Unit, Street, Barangay">
      </div>
      <div class="col-6">
        <label for="city">City/Municipality</label>
        <input id="city" placeholder="City">
      </div>
      <div class="col-3">
        <label for="province">Province</label>
        <input id="province" placeholder="Province">
      </div>
      <div class="col-3">
        <label for="zip">Zip</label>
        <input id="zip" placeholder="1000">
      </div>
    </div>
  </div>

  <!-- IDENTITY (match worker: two items with upload buttons + progress) -->
  <div class="card">
    <h2><span class="sec-dot"></span> Identity Verification</h2>
    <div class="body grid" id="idSection">
      <div class="col-6">
        <label for="idType">Valid ID Type (PH)</label>
        <select id="idType">
          <option value="">Select‚Ä¶</option>
          <option>PhilSys National ID</option>
          <option>Driver‚Äôs License</option>
          <option>Passport</option>
          <option>UMID</option>
          <option>SSS</option>
          <option>TIN</option>
          <option>PRC</option>
          <option>Postal ID</option>
          <option>Voter‚Äôs ID</option>
        </select>
      </div>
      <div class="col-6">
        <label for="idNumber">ID Number</label>
        <input id="idNumber" placeholder="Exact as on the ID">
      </div>

      <!-- ID FRONT -->
      <div class="col-6">
        <label for="idFront">Upload ID (Front)</label>
        <input id="idFront" type="file" accept="image/*" class="upload-control">
        <div class="upload-row">
          <button type="button" class="btn btn-mini" id="btnUploadIdFront">Upload</button>
          <div class="bar" aria-hidden="true"><span id="barIdFront"></span></div>
          <span id="statusIdFront" class="pill warn">Waiting file‚Ä¶</span>
        </div>
        <div class="file-note" id="linkIdFront"></div>
      </div>

      <!-- SELFIE WITH ID/TOOL -->
      <div class="col-6">
        <label for="selfieId">Selfie holding your ID/Tool</label>
        <input id="selfieId" type="file" accept="image/*" class="upload-control">
        <div class="upload-row">
          <button type="button" class="btn btn-mini" id="btnUploadSelfie">Upload</button>
          <div class="bar" aria-hidden="true"><span id="barSelfie"></span></div>
          <span id="statusSelfie" class="pill warn">Waiting file‚Ä¶</span>
        </div>
        <div class="file-note" id="linkSelfie"></div>
      </div>
      <div class="col-12"><div class="file-note">2 IDs required (ID Front + Selfie) to hit 100% identity.</div></div>
    </div>
  </div>

  <!-- BUSINESS / SOCIAL -->
  <div class="card">
    <h2><span class="sec-dot"></span> Business / Social Proof</h2>
    <div class="body grid">
      <div class="col-6">
        <label for="company">Business/Company Name (if any)</label>
        <input id="company" placeholder="DTI/SEC-registered name">
      </div>
      <div class="col-6">
        <label for="bizRegNo">DTI/SEC Reg No.</label>
        <input id="bizRegNo" placeholder="DTI-XXXXXXX / SEC-XXXXXXX">
      </div>
      <div class="col-6">
        <label for="website">Website</label>
        <input id="website" placeholder="https://yourdomain.com">
      </div>
      <div class="col-6">
        <label for="fb">Facebook Profile/Page</label>
        <input id="fb" placeholder="https://facebook.com/yourprofile">
      </div>
      <div class="col-6">
        <label for="linkedin">LinkedIn</label>
        <input id="linkedin" placeholder="https://linkedin.com/in/you">
      </div>
      <div class="col-6">
        <label for="altContact">Alternate Contact (optional)</label>
        <input id="altContact" placeholder="Viber/Telegram/Alt number">
      </div>
    </div>
  </div>

  <!-- REFERENCES -->
  <div class="card">
    <h2><span class="sec-dot"></span> References</h2>
    <div class="body grid">
      <div class="col-6">
        <label for="ref1Name">Reference 1 ‚Äî Name</label>
        <input id="ref1Name" placeholder="Name">
      </div>
      <div class="col-6">
        <label for="ref1Phone">Reference 1 ‚Äî Phone</label>
        <input id="ref1Phone" placeholder="+63 9xx xxx xxxx">
      </div>
      <div class="col-6">
        <label for="ref2Name">Reference 2 ‚Äî Name</label>
        <input id="ref2Name" placeholder="Name">
      </div>
      <div class="col-6">
        <label for="ref2Phone">Reference 2 ‚Äî Phone</label>
        <input id="ref2Phone" placeholder="+63 9xx xxx xxxx">
      </div>
    </div>
  </div>

  <!-- COMMUNITY RATING (read-only) -->
  <div class="card">
    <h2><span class="sec-dot"></span> Community Rating</h2>
    <div class="body">
      <div id="hirerAggregate" class="rating-line">
        <div class="stars" aria-hidden="true">
          <span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span>
        </div>
        <span id="ratingLabel" class="muted">No ratings yet</span>
      </div>
      <p class="hint" style="margin-top:8px">Workers can rate you after a completed job. Keep your profile complete to build trust.</p>
    </div>
  </div>

  <!-- DECLARATION -->
  <div class="card">
    <h2><span class="sec-dot"></span> Declaration</h2>
    <div class="body">
      <p class="muted">You can submit even if some fields are blank, but incomplete profiles may not be verified.</p>
      <textarea id="notes" placeholder="Anything we should know? (optional)"></textarea>
    </div>
  </div>

  <div class="actions" id="actionsBar">
    <button type="button" class="btn-ghost" id="saveDraft">Save Draft</button>
    <button type="button" class="btn" id="requestVerify">Request Verification</button>
    <button type="button" class="btn hide" id="adminUnlock">üîì Edit (Admin)</button>
  </div>
  </form>
</main>

<a class="fab-home" href="beehiremain.html" aria-label="Back to Home">
  <span class="icon">üè†</span><span class="label">Back to Home</span>
</a>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, serverTimestamp, onSnapshot,
    collection, query, where, limit, getDocs
  } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
  import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCkkVvflDza_lmFmUmsgUQv6iOiMW3y9bc",
    authDomain: "myapp-96865.firebaseapp.com",
    databaseURL: "https://myapp-96865-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "myapp-96865",
    // If Storage misbehaves, try: "myapp-96865.appspot.com"
    storageBucket: "myapp-96865.firebasestorage.app",
    messagingSenderId: "217431866794",
    appId: "1:217431866794:web:965d02cc01d12ae555ffd3",
    measurementId: "G-1T4M9PE1GD"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const alertBox = document.getElementById('alertBox');
  const okBox = document.getElementById('okBox');
  const statusBadge = document.getElementById('statusBadge');
  const meterDot = document.getElementById('meterDot');
  const meterLabel = document.getElementById('meterLabel');
  const meterBar = document.getElementById('meterBar');
  const meterPct = document.getElementById('meterPct');
  const readonlyNote = document.getElementById('readonlyNote');

  const avatarPreview = document.getElementById('avatarPreview');
  const profilePhotoInput = document.getElementById('profilePhoto');

  const $ = (id) => document.getElementById(id);
  const fields = [
    'fullName','email','phone','address1','city','province','zip',
    'idType','idNumber','company','bizRegNo','website','fb','linkedin',
    'altContact','ref1Name','ref1Phone','ref2Name','ref2Phone','notes'
  ];
  const filePaths = {}; // holds photoURL + id urls

  function showWarn(msg){ alertBox.textContent = msg; alertBox.style.display='block'; okBox.style.display='none'; }
  function showOk(msg){ okBox.textContent = msg; okBox.style.display='block'; alertBox.style.display='none'; }
  function hideAlerts(){ alertBox.style.display='none'; okBox.style.display='none'; }
  function isFilled(v){ return v && String(v).trim().length>0; }

  // avatar default
  function guestAvatar(size=84){
    const svg = `
      <svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'>
        <defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0%' stop-color='#FFE480'/><stop offset='100%' stop-color='#FFD000'/></linearGradient></defs>
        <rect width='100%' height='100%' rx='${size/2}' fill='url(#g)'/>
        <text x='50%' y='54%' text-anchor='middle' dominant-baseline='middle'
          font-family='Inter, Segoe UI, Arial' font-weight='800' font-size='14' fill='#111'>Avatar</text>
      </svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }
  avatarPreview.src = guestAvatar();

  // ---- Completeness (2 IDs = full; Biz/Social is +10 bonus) ----
  function computeCompleteness(doc){
    const basicFilled = [doc.fullName, doc.email, doc.phone].filter(isFilled).length;
    const addressFilled = [doc.address1, doc.city, doc.province, doc.zip].filter(isFilled).length;

    const basicScore = (basicFilled/3) * 40;
    const addrScore  = (addressFilled/4) * 40;

    const hasFront  = isFilled(doc.idFrontUrl);
    const hasSelfie = isFilled(doc.selfieIdUrl);
    const idScore   = (hasFront && hasSelfie) ? 20 : (hasFront || hasSelfie ? 10 : 0);

    const bizBits   = [doc.company, doc.bizRegNo, doc.website, doc.fb, doc.linkedin].filter(isFilled).length;
    const bizBonus  = bizBits > 0 ? 10 : 0;

    let total = Math.round(basicScore + addrScore + idScore + bizBonus);

    const hasRef = (isFilled(doc.ref1Name) && isFilled(doc.ref1Phone)) || (isFilled(doc.ref2Name) && isFilled(doc.ref2Phone));
    const displayPct = Math.min(110, total + (hasRef ? 10 : 0));

    meterBar.style.width = Math.min(100, displayPct) + '%';
    meterPct.textContent = displayPct + '%';

    if (displayPct >= 100){
      meterDot.className='dot ok'; meterLabel.textContent='Ready for verification';
    } else if (displayPct >= 50){
      meterDot.className='dot mid'; meterLabel.textContent='Partial ‚Äî add more to reach 100%';
    } else {
      meterDot.className='dot bad'; meterLabel.textContent='Incomplete ‚Äî fill required sections';
    }

    return { total, displayPct, hasRef };
  }

  function setStatusBadge(status){
    if (status === 'verified'){ statusBadge.className='badge b-verified'; statusBadge.textContent='Verified'; }
    else if (status === 'pending'){ statusBadge.className='badge b-pending'; statusBadge.textContent='Pending Review'; }
    else { statusBadge.className='badge b-incomplete'; statusBadge.textContent='Not Verified'; }
  }

  // ---------- Upload helpers (with progress like worker) ----------
  function setPill(el, cls, text){ el.className = `pill ${cls}`; el.textContent = text; }
  function sanitizeName(n){
    const dot = n.lastIndexOf('.');
    const base = dot>0 ? n.slice(0,dot) : n;
    const ext  = dot>0 ? n.slice(dot+1) : '';
    const cb = base.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,60);
    const ce = ext.toLowerCase().replace(/[^a-z0-9]/g,'').slice(0,10);
    return ce ? `${cb}.${ce}` : cb;
  }
  function fileKeyToSubfolder(k){
    switch(k){
      case 'idFrontUrl': return 'id-front';
      case 'selfieIdUrl': return 'selfie-id';
      case 'photoURL': return 'avatar';
      default: return 'misc';
    }
  }
  async function saveFileUrlToFirestore({ uid, fileKey, url, path }){
    const refDoc = doc(db,'hirers',uid);
    const sub = fileKeyToSubfolder(fileKey);
    await setDoc(refDoc, {
      uploads: {
        [sub]: { url, path, updatedAt: serverTimestamp(), provider: 'firebase-storage' }
      },
      [fileKey]: url,
      updatedAt: serverTimestamp()
    }, { merge:true });
  }

  function wireUploader({inputId, buttonId, barId, statusId, linkId, fileKey}){
    const input = $(inputId), btn = $(buttonId), bar = $(barId), status = $(statusId), link = $(linkId);
    const disable = (on)=>{ if(btn) btn.disabled = on; if(input) input.disabled = on; };
    btn.addEventListener('click', async ()=>{
      const user = auth.currentUser;
      if (!user){ showWarn('Please log in first.'); return; }
      if (!input.files || !input.files.length){ setPill(status,'bad','No file selected'); return; }

      const f = input.files[0];
      const safe = sanitizeName(f.name || 'upload.jpg');
      const objectPath = `hirers/${user.uid}/${fileKeyToSubfolder(fileKey)}/${safe}`;
      const ref = sref(storage, objectPath);
      try{
        disable(true);
        setPill(status,'warn','Uploading‚Ä¶');
        bar.style.width = '0%';

        const task = uploadBytesResumable(ref, f, {
          contentType: f.type || undefined,
          cacheControl: 'public,max-age=3600',
          customMetadata: { fieldKey:fileKey, uploadedBy:user.uid }
        });

        task.on('state_changed', (snap)=>{
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          bar.style.width = pct + '%';
          status.textContent = `Uploading‚Ä¶ ${pct}%`;
        }, (err)=>{
          console.error(err);
          setPill(status,'bad', err.code || 'Upload failed');
          disable(false);
        }, async ()=>{
          const url = await getDownloadURL(ref);
          setPill(status,'ok','Uploaded ‚úì');
          link.innerHTML = `<a href="${url}" target="_blank" rel="noopener">${safe}</a>`;
          filePaths[fileKey] = url;
          await saveFileUrlToFirestore({ uid:user.uid, fileKey, url, path:objectPath });
          disable(false);
        });
      }catch(e){
        console.error(e);
        setPill(status,'bad', e.message || 'Upload failed');
        disable(false);
      }
    });
  }

  // rating aggregate (read-only)
  function paintStars(container, avg){
    const stars = container.querySelectorAll('.star');
    const n = Math.round(Number(avg||0));
    stars.forEach((s,i)=> s.classList.toggle('on', i < n));
  }
  function mountHirerAggregate(uid){
    const aggWrap = document.getElementById('hirerAggregate');
    const label = document.getElementById('ratingLabel');
    const refAgg = doc(db, 'hirers', uid);
    onSnapshot(refAgg, (snap)=>{
      const d = snap.data() || {};
      const avg = Number(d.averageRating||0);
      const cnt = Number(d.ratingCount||0);
      paintStars(aggWrap, avg);
      label.textContent = cnt ? `${avg.toFixed(1)} (${cnt} review${cnt>1?'s':''})` : 'No ratings yet';
    });
  }

  function collectForm(){
    const data = {}; fields.forEach(f=> data[f] = $(f)?.value?.trim() || ''); return data;
  }
  function fillForm(docData){
    fields.forEach(f=>{
      const el = $(f); if (!el) return;
      if (!el.value && docData?.[f] !== undefined && docData[f] !== null){ el.value = docData[f]; }
    });
    const url = docData?.photoURL || docData?.profileImageUrl || docData?.profilePhoto || docData?.avatarUrl || '';
    if (url && avatarPreview.src !== url) avatarPreview.src = url;
  }
  function setReadOnly(lock){
    fields.forEach(f=>{ const el = $(f); if (el) el.disabled = !!lock; });
    document.querySelectorAll('.upload-control').forEach(inp=>{ inp.classList.toggle('hide', !!lock); });
    ['saveDraft','requestVerify'].forEach(id=>{ const b=$(id); if (b) b.classList.toggle('hide', !!lock); });
    readonlyNote.classList.toggle('hide', !lock);
  }

  // ---------- AUTO-FILL FROM WORKERS BY EMAIL ----------
  async function findWorkerByEmail(emailValue){
    if (!emailValue) return null;
    try{
      const qy = query(collection(db,'workers'), where('email','==', emailValue), limit(1));
      const snap = await getDocs(qy);
      if (snap.empty) return null;
      const docSnap = snap.docs[0];
      return { id: docSnap.id, ...docSnap.data() };
    }catch(e){
      console.warn('findWorkerByEmail failed:', e?.message || e);
      return null;
    }
  }
  function mapWorkerToHirer(worker){
    const mapped = {};
    mapped.fullName = worker.fullName || worker.name || '';
    mapped.email    = worker.email || '';
    mapped.phone    = worker.phone || '';
    mapped.address1 = worker.address1 || worker.location || worker.barangay || '';
    mapped.city     = worker.city || '';
    mapped.province = worker.province || '';
    mapped.zip      = worker.zip || '';

    if (worker.idType)           mapped.idType = worker.idType;
    if (worker.idNumber)         mapped.idNumber = worker.idNumber;
    if (worker.idFrontUrl)       mapped.idFrontUrl = worker.idFrontUrl;
    if (worker.selfieToolUrl)    mapped.selfieIdUrl = worker.selfieToolUrl;

    if (worker.fb) mapped.fb = worker.fb;

    mapped.photoURL = worker.profileImageUrl || worker.photoUrl || worker.photoURL || '';

    const uploads = {};
    if (worker.uploads && typeof worker.uploads === 'object'){
      if (worker.uploads['id-front']) uploads['id-front'] = worker.uploads['id-front'];
      if (worker.uploads['selfie-tool']) uploads['selfie-id'] = worker.uploads['selfie-tool'];
      if (worker.uploads['brgy-clearance']) uploads['brgy-clearance'] = worker.uploads['brgy-clearance'];
      if (worker.uploads['nbi-clearance'])  uploads['nbi-clearance']  = worker.uploads['nbi-clearance'];
      if (worker.uploads['portfolio'])      uploads['portfolio']      = worker.uploads['portfolio'];
    }
    if (Object.keys(uploads).length) mapped.uploads = uploads;

    if (worker.verificationStatus) mapped._workerVerificationStatus = worker.verificationStatus;
    if (worker.storageFolder) mapped.sourceWorkerStorageFolder = worker.storageFolder;
    return mapped;
  }
  function mergeIfEmpty(target, patch){
    const out = {...target};
    Object.keys(patch).forEach(k=>{
      if (k==='uploads'){ out.uploads = { ...(out.uploads||{}), ...(patch.uploads||{}) }; return; }
      const cur = out[k];
      if (cur===undefined || cur===null || String(cur).trim()===''){ out[k]=patch[k]; }
    });
    return out;
  }
  async function hydrateHirerFromWorkerIfMatch(user, hirerDocData){
    if (hirerDocData?.hydratedFromWorker) return hirerDocData;
    const emailCandidate = hirerDocData?.email || user?.email || (user?.providerData && user.providerData[0]?.email) || '';
    const worker = await findWorkerByEmail(emailCandidate);
    if (!worker) return hirerDocData;

    const mapped = mapWorkerToHirer(worker);
    let merged = mergeIfEmpty(hirerDocData || {}, mapped);
    if ((merged.verificationStatus || 'unverified') === 'unverified' && mapped._workerVerificationStatus){
      merged.verificationStatus = mapped._workerVerificationStatus;
    }
    merged.hydratedFromWorker = true;
    merged.sourceWorkerId = worker.uid || worker.id || null;
    merged.hydratedAt = serverTimestamp();

    await setDoc(doc(db,'hirers', user.uid), merged, { merge:true });

    ['idFrontUrl','selfieIdUrl','photoURL'].forEach(k=>{ if (merged[k]) filePaths[k]=merged[k]; });
    if (merged.photoURL) avatarPreview.src = merged.photoURL;

    fillForm(merged);
    setStatusBadge(merged.verificationStatus || 'unverified');
    computeCompleteness(merged);

    return merged;
  }
  // ---------- END auto-fill ----------

  // preview avatar when user picks file
  profilePhotoInput.addEventListener('change', ()=>{
    const f = profilePhotoInput.files?.[0]; if (!f) return;
    const reader = new FileReader();
    reader.onload = e => { avatarPreview.src = e.target.result; };
    reader.readAsDataURL(f);
  });

  // INIT
  onAuthStateChanged(auth, async (user)=>{
    if (!user){
      showWarn('Please log in first. Redirecting to login‚Ä¶');
      setTimeout(()=>{ window.location.href='hirer-login.html'; }, 1200);
      return;
    }
    try{
      // Admin flag
      const adminSnap = await getDoc(doc(db,'Admin',user.uid));
      const adminFlag = adminSnap.exists();

      // Load/create hirer doc
      const hRef = doc(db,'hirers',user.uid);
      const hSnap = await getDoc(hRef);

      let data = {};
      if (hSnap.exists()) data = hSnap.data();
      else {
        data = {
          uid: user.uid,
          fullName: user.displayName || '',
          email: user.email || (user.providerData && user.providerData[0]?.email) || '',
          phone: user.phoneNumber || '',
          role: 'hirer',
          verificationStatus: 'unverified',
          photoURL: user.photoURL || '',
          createdAt: serverTimestamp()
        };
        await setDoc(hRef, data, { merge:true });
      }

      // preload stored urls
      ['idFrontUrl','selfieIdUrl','photoURL','avatarUrl'].forEach(k=>{ if (data[k]) filePaths[k]=data[k]; });

      // Fill UI + status + meter
      fillForm(data);
      setStatusBadge(data.verificationStatus || 'unverified');
      computeCompleteness(data);

      // AUTO-FILL from workers if same email
      data = await hydrateHirerFromWorkerIfMatch(user, data);

      // rating aggregate
      mountHirerAggregate(user.uid);

      const verified = (data.verificationStatus === 'verified');
      setReadOnly(verified && !adminFlag);

      if (adminFlag){
        const btn = document.getElementById('adminUnlock');
        btn.classList.remove('hide');
        let unlocked = !verified;
        btn.addEventListener('click', ()=>{
          unlocked = !unlocked;
          setReadOnly(!unlocked);
          btn.textContent = unlocked ? 'üîí Lock (Admin)' : 'üîì Edit (Admin)';
        });
      }

      // Wire uploaders (match worker)
      wireUploader({inputId:'idFront',   buttonId:'btnUploadIdFront', barId:'barIdFront',  statusId:'statusIdFront',  linkId:'linkIdFront',  fileKey:'idFrontUrl'});
      wireUploader({inputId:'selfieId',  buttonId:'btnUploadSelfie',  barId:'barSelfie',   statusId:'statusSelfie',   linkId:'linkSelfie',   fileKey:'selfieIdUrl'});
      // Optional: allow avatar upload with progress too (click-less on save)
      // wireUploader({inputId:'profilePhoto', buttonId:'btnUploadAvatar', ...}) // left as manual on save

    }catch(e){
      console.error(e);
      showWarn('Could not load your profile. Please refresh the page.');
    }
  });

  async function saveDraft(uid, alsoRequest=false){
    try{
      hideAlerts();

      // If user picked avatar, upload with resumable as well (no button)
      if (profilePhotoInput.files && profilePhotoInput.files[0]){
        const f = profilePhotoInput.files[0];
        const safe = sanitizeName(f.name || 'avatar.jpg');
        const objectPath = `hirers/${uid}/avatar/${safe}`;
        const ref = sref(storage, objectPath);
        await new Promise((res, rej)=>{
          const t = uploadBytesResumable(ref, f, { contentType:f.type||undefined, cacheControl:'public,max-age=3600', customMetadata:{fieldKey:'photoURL', uploadedBy:uid}});
          t.on('state_changed', ()=>{}, rej, res);
        });
        const url = await getDownloadURL(ref);
        filePaths.photoURL = url; avatarPreview.src = url;
        await saveFileUrlToFirestore({ uid, fileKey:'photoURL', url, path:objectPath });
      }

      const payload = {
        ...collectForm(),
        ...filePaths,
        uid, role:'hirer',
        updatedAt: serverTimestamp()
      };
      if (alsoRequest){
        payload.verificationStatus = 'pending';
        payload.verificationRequestedAt = serverTimestamp();
      }

      await setDoc(doc(db,'hirers',uid), payload, { merge:true });

      const { displayPct } = computeCompleteness(payload);
      if (alsoRequest){
        setStatusBadge('pending');
        if (displayPct < 100){
          showWarn('Submitted for review. Tip: add more details to reach 100% for faster approval.');
        } else {
          showOk('Submitted for verification. Looks complete ‚Äî we‚Äôll review shortly.');
        }
      } else {
        showOk('Draft saved.');
      }
    }catch(e){
      console.error(e);
      showWarn('Save failed: ' + (e.message || e.code));
    }
  }

  document.getElementById('saveDraft').addEventListener('click', async ()=>{
    const user = auth.currentUser; if (!user) return; await saveDraft(user.uid,false);
  });
  document.getElementById('requestVerify').addEventListener('click', async ()=>{
    const user = auth.currentUser; if (!user) return;
    const d = { ...collectForm(), ...filePaths };
    const basicOk   = isFilled(d.fullName) && isFilled(d.email) && isFilled(d.phone);
    const addressOk = isFilled(d.address1) && isFilled(d.city) && isFilled(d.province) && isFilled(d.zip);
    const idOk      = isFilled(d.idFrontUrl) && isFilled(d.selfieIdUrl); // require 2 IDs for 100%
    if (!(basicOk && addressOk && idOk)){
      showWarn('Heads up: to reach 100%, complete Basic + Address + TWO IDs (ID Front + Selfie). You can still submit now; Business/Social can add +10% bonus.');
    }
    await saveDraft(user.uid,true);
  });
</script>
</body>
</html>
