<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Beehire — Hirer Verification</title>

<!-- Corporate font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --brand:#FFC107;           /* corporate honey gold */
    --brand-ink:#0E2A32;       /* deep navy */
    --ink:#0E2A32;
    --muted:#6B7B84;
    --bg:#F6F9FC;              /* cleaner, corporate background */
    --card:#ffffff;
    --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    --line:#E6EDF2; --line-strong:#D7E1EA;
    --focus:#2C7BE5;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
    margin:0; background:linear-gradient(180deg,#FFFFFF 0%, var(--bg) 70%);
    color:var(--ink);
  }

  /* Header */
  header{
    position:sticky; top:0; z-index:50;
    background:var(--card);
    border-bottom:1px solid var(--line);
    box-shadow:0 2px 10px rgba(14,42,50,.04);
  }
  .nav{
    max-width:1100px; margin:0 auto; padding:12px 18px;
    display:flex; align-items:center; justify-content:space-between; gap:16px;
  }
  .brand{display:flex; align-items:center; gap:12px; text-decoration:none}
  .brand-logo{width:42px; height:42px; object-fit:contain; filter:drop-shadow(0 2px 8px rgba(0,0,0,.06))}
  .brand-title{display:flex; flex-direction:column; line-height:1.1}
  .brand-title .name{font-weight:800; font-size:1.1rem; color:var(--brand-ink); letter-spacing:.2px}
  .brand-title .tag{font-size:.78rem; color:var(--muted); font-weight:700; letter-spacing:.3px}

  .status{
    display:flex; align-items:center; gap:10px; color:var(--muted); font-weight:700;
  }
  .badge{
    padding:6px 10px; border-radius:999px; font-weight:800; font-size:.85rem;
    border:1px solid var(--line-strong); background:#fff; color:var(--brand-ink);
  }
  .b-verified{background:#dcfce7;color:#166534;border-color:#86efac}
  .b-pending{background:#fffbeb;color:#92400e;border-color:#fde68a}
  .b-incomplete{background:#fef2f2;color:#991b1b;border-color:#fecaca}

  /* Main */
  main{max-width:1100px; margin:28px auto 100px; padding:0 18px}
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:16px;
    box-shadow:0 10px 24px rgba(14,42,50,.06);
    margin-bottom:16px; overflow:hidden;
  }
  .card h2{
    margin:0; padding:16px 18px; border-bottom:1px solid var(--line);
    font-size:1.1rem; letter-spacing:.2px; display:flex; align-items:center; gap:10px;
  }
  .card h2 .sec-dot{width:8px; height:8px; border-radius:2px; background:var(--brand)}
  .card .body{padding:18px}

  .grid{display:grid; gap:14px; grid-template-columns:repeat(12,1fr)}
  .col-12{grid-column:span 12}
  .col-6{grid-column:span 12}
  @media(min-width:720px){ .col-6{grid-column:span 6} }

  label{font-weight:800; font-size:.92rem; margin-bottom:6px; display:block; color:var(--brand-ink)}
  input,select,textarea{
    width:100%; padding:11px 12px; border:1px solid var(--line-strong);
    border-radius:12px; font-size:1rem; background:#fff; color:var(--ink);
    transition:border-color .15s, box-shadow .15s, background .15s;
  }
  input:hover,select:hover,textarea:hover{ background:#FCFEFF }
  input:focus,select:focus,textarea:focus{
    outline:none; border-color:var(--focus); box-shadow:0 0 0 3px rgba(44,123,229,.15)
  }
  textarea{min-height:90px; resize:vertical}

  .muted{color:var(--muted); font-size:.9rem}
  .hint{font-size:.9rem; color:#4b5563; margin-top:6px}

  /* sticky actions bar */
  .actions{
    display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    padding:16px; border-top:1px solid var(--line); position:sticky; bottom:0;
    background:rgba(255,255,255,.92); backdrop-filter:saturate(160%) blur(6px);
    z-index:10;
  }
  button{border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer}
  .btn{
    background:var(--brand); color:#111;
    box-shadow:0 8px 20px rgba(255,193,7,.28); transition:transform .06s, box-shadow .15s, filter .15s;
  }
  .btn:hover{filter:brightness(.98); box-shadow:0 12px 26px rgba(255,193,7,.38)}
  .btn:active{transform:translateY(1px)}
  .btn-ghost{
    background:#fff; border:1px solid var(--line-strong); color:var(--brand-ink);
  }
  .btn-ghost:hover{box-shadow:0 8px 20px rgba(14,42,50,.05)}

  .warn{
    background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12;
    border-radius:12px; padding:12px 14px; margin-bottom:14px
  }
  .success{
    background:#ecfeff; border:1px solid #a5f3fc; color:#075985;
    border-radius:12px; padding:12px 14px; margin-bottom:14px
  }

  /* completeness meter */
  .kv{display:flex; gap:10px; align-items:center}
  .kv .dot{width:10px; height:10px; border-radius:2px}
  .dot.ok{background:var(--ok)} .dot.mid{background:#f59e0b} .dot.bad{background:var(--bad)}
  .meter{height:10px; background:#f1f5f9; border-radius:999px; overflow:hidden; margin-top:8px}
  .meter > span{display:block; height:100%; background:linear-gradient(90deg,#f97316,#f59e0b,#84cc16)}

  .file-note{font-size:.85rem; color:#555; margin-top:6px}
  .hide{display:none !important}
  .readonly-note{
    background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46;
    padding:10px 12px; border-radius:10px; margin:12px 18px
  }

  /* avatar */
  .avatar-wrap{display:flex; align-items:center; gap:16px}
  .avatar{
    width:84px; height:84px; border-radius:50%; border:3px solid var(--brand);
    object-fit:cover; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.08)
  }

  /* FAB Home */
  .fab-home{
    position:fixed; left:max(16px, env(safe-area-inset-left)); bottom:max(16px, env(safe-area-inset-bottom));
    z-index:80; display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border-radius:999px;
    background:var(--brand); color:#111; font-weight:800; font-size:.95rem; text-decoration:none;
    border:1px solid #e6c200; box-shadow:0 8px 24px rgba(0,0,0,.18);
    transition:transform .18s, box-shadow .18s, background .18s, opacity .18s; animation:fabsin .25s ease-out both;
  }
  .fab-home:hover{ transform:translateY(-2px) scale(1.02); box-shadow:0 12px 30px rgba(0,0,0,.22); background:#ffce00 }
  .fab-home:active{ transform:translateY(0) scale(.98); box-shadow:0 6px 16px rgba(0,0,0,.16) }
  .fab-home .icon{ width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; filter:drop-shadow(0 1px 0 rgba(255,255,255,.4)) }
  .fab-home .label{ white-space:nowrap }
  @media (max-width:420px){ .fab-home{ padding:10px 12px; gap:8px; font-size:.9rem } .fab-home .label{ display:none } }
  @keyframes fabsin{ from{ transform:translateY(8px); opacity:0 } to{ transform:translateY(0); opacity:1 } }

  /* rating */
  .rating-line{display:flex; align-items:center; gap:10px}
  .stars{display:inline-flex; gap:4px}
  .star{font-size:18px; filter:grayscale(1)}
  .star.on{filter:grayscale(0)}
</style>
</head>
<body>

<header>
  <div class="nav">
    <a class="brand" href="#">
      <img class="brand-logo" src="BeeHire Logo.png" alt="Beehire logo">
      <span class="brand-title">
        <span class="name">Beehire</span>
        <span class="tag">Hirer Verification</span>
      </span>
    </a>
    <div class="status">
      <span>Status:</span>
      <span id="statusBadge" class="badge b-incomplete">Not Verified</span>
    </div>
  </div>
</header>

<main>
  <div id="alertBox" class="warn" style="display:none"></div>
  <div id="okBox" class="success" style="display:none"></div>
  <div id="readonlyNote" class="readonly-note hide">✅ Verified profile — read-only. Contact support or an admin to make changes.</div>

  <!-- Completeness -->
  <div class="card">
    <h2><span class="sec-dot"></span> Profile Completeness</h2>
    <div class="body">
      <div class="kv" style="justify-content:space-between">
        <div class="kv"><span class="dot bad" id="meterDot"></span> <span id="meterLabel" class="muted">Incomplete</span></div>
        <div class="muted"><span id="meterPct">0%</span> complete</div>
      </div>
      <div class="meter" aria-hidden="true"><span id="meterBar" style="width:0%"></span></div>
      <p class="hint">
        To reach <b>100%</b>: complete <b>Basic Information</b>, <b>Address</b>, and either <b>Identity Verification</b> <i>or</i> <b>Business/Social Proof</b>.<br>
        Add at least one <b>Reference</b> for a <b>+10%</b> boost (faster anti-scam checks).
      </p>
    </div>
  </div>

  <!-- BASIC -->
  <form id="form">
  <div class="card">
    <h2><span class="sec-dot"></span> Basic Information</h2>
    <div class="body grid">
      <div class="col-12">
        <label>Profile Photo</label>
        <div class="avatar-wrap">
          <img id="avatarPreview" class="avatar" alt="Profile">
          <input id="profilePhoto" type="file" accept="image/*" class="upload-control">
        </div>
        <div class="file-note">Tip: Clear front-facing photo (JPEG/PNG).</div>
      </div>

      <div class="col-6">
        <label for="fullName">Full Name (as per ID)</label>
        <input id="fullName" placeholder="Juan D. Dela Cruz">
      </div>
      <div class="col-6">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="juan@email.com">
      </div>
      <div class="col-6">
        <label for="phone">Phone</label>
        <input id="phone" placeholder="+63 9xx xxx xxxx">
      </div>
      <div class="col-6">
        <label for="role">Role</label>
        <input id="role" value="hirer" disabled>
      </div>
    </div>
  </div>

  <!-- ADDRESS -->
  <div class="card">
    <h2><span class="sec-dot"></span> Address</h2>
    <div class="body grid">
      <div class="col-12">
        <label for="address1">Address Line</label>
        <input id="address1" placeholder="House/Unit, Street, Barangay">
      </div>
      <div class="col-6">
        <label for="city">City/Municipality</label>
        <input id="city" placeholder="City">
      </div>
      <div class="col-3">
        <label for="province">Province</label>
        <input id="province" placeholder="Province">
      </div>
      <div class="col-3">
        <label for="zip">Zip</label>
        <input id="zip" placeholder="1000">
      </div>
    </div>
  </div>

  <!-- ID & SELFIE -->
  <div class="card">
    <h2><span class="sec-dot"></span> Identity Verification</h2>
    <div class="body grid" id="idSection">
      <div class="col-6">
        <label for="idType">Valid ID Type (PH)</label>
        <select id="idType">
          <option value="">Select…</option>
          <option>PhilSys National ID</option>
          <option>Driver’s License</option>
          <option>Passport</option>
          <option>UMID</option>
          <option>SSS</option>
          <option>TIN</option>
          <option>PRC</option>
          <option>Postal ID</option>
          <option>Voter’s ID</option>
        </select>
      </div>
      <div class="col-6">
        <label for="idNumber">ID Number</label>
        <input id="idNumber" placeholder="Exact as on the ID">
      </div>
      <div class="col-6">
        <label for="idFront">Upload ID (Front)</label>
        <input id="idFront" type="file" accept="image/*" class="upload-control">
        <div class="file-note">JPEG/PNG only.</div>
      </div>
      <div class="col-6">
        <label for="idBack">Upload ID (Back)</label>
        <input id="idBack" type="file" accept="image/*" class="upload-control">
      </div>
      <div class="col-12">
        <label for="selfieId">Selfie holding your ID</label>
        <input id="selfieId" type="file" accept="image/*" class="upload-control">
        <div class="file-note">Make sure the face and ID are readable.</div>
      </div>
    </div>
  </div>

  <!-- BUSINESS / SOCIAL -->
  <div class="card">
    <h2><span class="sec-dot"></span> Business / Social Proof</h2>
    <div class="body grid">
      <div class="col-6">
        <label for="company">Business/Company Name (if any)</label>
        <input id="company" placeholder="DTI/SEC-registered name">
      </div>
      <div class="col-6">
        <label for="bizRegNo">DTI/SEC Reg No.</label>
        <input id="bizRegNo" placeholder="DTI-XXXXXXX / SEC-XXXXXXX">
      </div>
      <div class="col-6">
        <label for="website">Website</label>
        <input id="website" placeholder="https://yourdomain.com">
      </div>
      <div class="col-6">
        <label for="fb">Facebook Profile/Page</label>
        <input id="fb" placeholder="https://facebook.com/yourprofile">
      </div>
      <div class="col-6">
        <label for="linkedin">LinkedIn</label>
        <input id="linkedin" placeholder="https://linkedin.com/in/you">
      </div>
      <div class="col-6">
        <label for="altContact">Alternate Contact (optional)</label>
        <input id="altContact" placeholder="Viber/Telegram/Alt number">
      </div>
    </div>
  </div>

  <!-- REFERENCES -->
  <div class="card">
    <h2><span class="sec-dot"></span> References</h2>
    <div class="body grid">
      <div class="col-6">
        <label for="ref1Name">Reference 1 — Name</label>
        <input id="ref1Name" placeholder="Name">
      </div>
      <div class="col-6">
        <label for="ref1Phone">Reference 1 — Phone</label>
        <input id="ref1Phone" placeholder="+63 9xx xxx xxxx">
      </div>
      <div class="col-6">
        <label for="ref2Name">Reference 2 — Name</label>
        <input id="ref2Name" placeholder="Name">
      </div>
      <div class="col-6">
        <label for="ref2Phone">Reference 2 — Phone</label>
        <input id="ref2Phone" placeholder="+63 9xx xxx xxxx">
      </div>
    </div>
  </div>

  <!-- COMMUNITY RATING (read-only) -->
  <div class="card">
    <h2><span class="sec-dot"></span> Community Rating</h2>
    <div class="body">
      <div id="hirerAggregate" class="rating-line">
        <div class="stars" aria-hidden="true">
          <span class="star">★</span><span class="star">★</span><span class="star">★</span><span class="star">★</span><span class="star">★</span>
        </div>
        <span id="ratingLabel" class="muted">No ratings yet</span>
      </div>
      <p class="hint" style="margin-top:8px">Workers can rate you after a completed job. Keep your profile complete to build trust.</p>
    </div>
  </div>

  <!-- DECLARATION -->
  <div class="card">
    <h2><span class="sec-dot"></span> Declaration</h2>
    <div class="body">
      <p class="muted">You can submit even if some fields are blank, but incomplete profiles may not be verified.</p>
      <textarea id="notes" placeholder="Anything we should know? (optional)"></textarea>
    </div>
  </div>

  <div class="actions" id="actionsBar">
    <button type="button" class="btn-ghost" id="saveDraft">Save Draft</button>
    <button type="button" class="btn" id="requestVerify">Request Verification</button>
    <button type="button" class="btn hide" id="adminUnlock">🔓 Edit (Admin)</button>
  </div>
  </form>
</main>

<a class="fab-home" href="beehiremain.html" aria-label="Back to Home">
  <span class="icon">🏠</span><span class="label">Back to Home</span>
</a>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
  import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCkkVvflDza_lmFmUmsgUQv6iOiMW3y9bc",
        authDomain: "myapp-96865.firebaseapp.com",
        databaseURL: "https://myapp-96865-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "myapp-96865",
        // If Storage misbehaves, try: "myapp-96865.appspot.com"
        storageBucket: "myapp-96865.firebasestorage.app",
        messagingSenderId: "217431866794",
        appId: "1:217431866794:web:965d02cc01d12ae555ffd3",
        measurementId: "G-1T4M9PE1GD"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const alertBox = document.getElementById('alertBox');
  const okBox = document.getElementById('okBox');
  const statusBadge = document.getElementById('statusBadge');
  const meterDot = document.getElementById('meterDot');
  const meterLabel = document.getElementById('meterLabel');
  const meterBar = document.getElementById('meterBar');
  const meterPct = document.getElementById('meterPct');
  const readonlyNote = document.getElementById('readonlyNote');
  const adminUnlockBtn = document.getElementById('adminUnlock');

  const avatarPreview = document.getElementById('avatarPreview');
  const profilePhotoInput = document.getElementById('profilePhoto');

  const $ = (id) => document.getElementById(id);
  const fields = [
    'fullName','email','phone','address1','city','province','zip',
    'idType','idNumber','company','bizRegNo','website','fb','linkedin',
    'altContact','ref1Name','ref1Phone','ref2Name','ref2Phone','notes'
  ];
  const filePaths = {}; // also holds photoURL/id urls

  function showWarn(msg){ alertBox.textContent = msg; alertBox.style.display='block'; okBox.style.display='none'; }
  function showOk(msg){ okBox.textContent = msg; okBox.style.display='block'; alertBox.style.display='none'; }
  function hideAlerts(){ alertBox.style.display='none'; okBox.style.display='none'; }
  function isFilled(v){ return v && String(v).trim().length>0; }

  // avatar default
  function guestAvatar(size=84){
    const svg = `
      <svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'>
        <defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0%' stop-color='#FFE480'/><stop offset='100%' stop-color='#FFD000'/></linearGradient></defs>
        <rect width='100%' height='100%' rx='${size/2}' fill='url(#g)'/>
        <text x='50%' y='54%' text-anchor='middle' dominant-baseline='middle'
          font-family='Inter, Segoe UI, Arial' font-weight='800' font-size='14' fill='#111'>Avatar</text>
      </svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }
  avatarPreview.src = guestAvatar();

  function computeCompleteness(doc){
    const basicFilled = [doc.fullName, doc.email, doc.phone].filter(isFilled).length;
    const basicTotal = 3;
    const addressFilled = [doc.address1, doc.city, doc.province, doc.zip].filter(isFilled).length;
    const addressTotal = 4;

    const idBits = [doc.idType, doc.idNumber, doc.idFrontUrl, doc.selfieIdUrl].filter(isFilled).length;
    const bizBits = [doc.company, doc.bizRegNo, doc.website, doc.fb, doc.linkedin].filter(isFilled).length;

    const basicScore = (basicFilled/basicTotal) * 40;
    const addrScore  = (addressFilled/addressTotal) * 40;
    const idScore    = Math.min(1, idBits/4) * 20;
    const bizScore   = Math.min(1, bizBits/5) * 20;
    const eitherScore = Math.max(idScore, bizScore);

    let total = Math.round(basicScore + addrScore + eitherScore);

    const ref1Ok = isFilled(doc.ref1Name) && isFilled(doc.ref1Phone);
    const ref2Ok = isFilled(doc.ref2Name) && isFilled(doc.ref2Phone);
    const hasRef = ref1Ok || ref2Ok;
    const displayPct = Math.min(110, total + (hasRef ? 10 : 0));

    meterBar.style.width = Math.min(100, displayPct) + '%';
    meterPct.textContent = displayPct + '%';

    if (displayPct >= 100){
      meterDot.className='dot ok'; meterLabel.textContent='Ready for verification';
    } else if (displayPct >= 50){
      meterDot.className='dot mid'; meterLabel.textContent='Partial — add more to reach 100%';
    } else {
      meterDot.className='dot bad'; meterLabel.textContent='Incomplete — fill required sections';
    }

    return { total, displayPct, hasRef };
  }

  function setStatusBadge(status){
    if (status === 'verified'){ statusBadge.className='badge b-verified'; statusBadge.textContent='Verified'; }
    else if (status === 'pending'){ statusBadge.className='badge b-pending'; statusBadge.textContent='Pending Review'; }
    else { statusBadge.className='badge b-incomplete'; statusBadge.textContent='Not Verified'; }
  }

  async function uploadIfAny(uid, inputId, destName){
    const input = $(inputId);
    if (!input || !input.files || !input.files.length) return null;
    const file = input.files[0];
    const path = `hirers/${uid}/${destName}`;
    const ref = sref(storage, path);
    await uploadBytes(ref, file);
    return await getDownloadURL(ref);
  }

  // rating aggregate (read-only)
  function paintStars(container, avg){
    const stars = container.querySelectorAll('.star');
    const n = Math.round(Number(avg||0));
    stars.forEach((s,i)=> s.classList.toggle('on', i < n));
  }
  function mountHirerAggregate(uid){
    const aggWrap = document.getElementById('hirerAggregate');
    const label = document.getElementById('ratingLabel');
    const ref = doc(db, 'hirers', uid);
    onSnapshot(ref, (snap)=>{
      const d = snap.data() || {};
      const avg = Number(d.averageRating||0);
      const cnt = Number(d.ratingCount||0);
      paintStars(aggWrap, avg);
      label.textContent = cnt ? `${avg.toFixed(1)} (${cnt} review${cnt>1?'s':''})` : 'No ratings yet';
    });
  }

  function collectForm(){
    const data = {};
    fields.forEach(f=> data[f] = $(f)?.value?.trim() || '');
    return data;
  }

  function fillForm(docData){
    fields.forEach(f=>{ if ($(f) && docData?.[f] !== undefined) $(f).value = docData[f]; });
    const url = docData?.photoURL || '';
    if (url) avatarPreview.src = url;
  }

  function setReadOnly(lock){
    fields.forEach(f=>{
      const el = $(f);
      if (el) el.disabled = !!lock;
    });
    document.querySelectorAll('.upload-control').forEach(inp=>{
      if (lock) inp.classList.add('hide'); else inp.classList.remove('hide');
    });
    const saveBtn = document.getElementById('saveDraft');
    const reqBtn  = document.getElementById('requestVerify');
    if (saveBtn) saveBtn.classList.toggle('hide', !!lock);
    if (reqBtn)  reqBtn.classList.toggle('hide', !!lock);
    readonlyNote.classList.toggle('hide', !lock);
  }

  async function saveDraft(uid, alsoRequest=false){
    try{
      hideAlerts();

      // uploads (IDs + profile avatar)
      const frontUrl = await uploadIfAny(uid,'idFront','id-front.jpg');
      const backUrl  = await uploadIfAny(uid,'idBack','id-back.jpg');
      const selfieUrl= await uploadIfAny(uid,'selfieId','selfie-id.jpg');
      const avatarUrl= await uploadIfAny(uid,'profilePhoto','avatar.jpg');

      if (frontUrl) filePaths.idFrontUrl = frontUrl;
      if (backUrl)  filePaths.idBackUrl  = backUrl;
      if (selfieUrl)filePaths.selfieIdUrl= selfieUrl;
      if (avatarUrl){ filePaths.photoURL = avatarUrl; avatarPreview.src = avatarUrl; }

      const payload = {
        ...collectForm(),
        ...filePaths,
        uid, role:'hirer',
        updatedAt: serverTimestamp()
      };
      if (alsoRequest){
        payload.verificationStatus = 'pending';
        payload.verificationRequestedAt = serverTimestamp();
      }

      await setDoc(doc(db,'hirers',uid), payload, { merge:true });

      const { displayPct } = computeCompleteness(payload);
      if (alsoRequest){
        setStatusBadge('pending');
        if (displayPct < 100){
          showWarn('Submitted for review. Tip: add more details to reach 100% for faster approval.');
        } else {
          showOk('Submitted for verification. Looks complete — we’ll review shortly.');
        }
      } else {
        showOk('Draft saved.');
      }
    }catch(e){
      console.error(e);
      showWarn('Save failed: ' + (e.message || e.code));
    }
  }

  async function isAdmin(uid){
    try{
      const aRef = doc(db,'Admin',uid);
      const aSnap = await getDoc(aRef);
      return aSnap.exists();
    }catch(_){ return false; }
  }

  // preview avatar when user picks file
  profilePhotoInput.addEventListener('change', ()=>{
    const f = profilePhotoInput.files?.[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = e => { avatarPreview.src = e.target.result; };
    reader.readAsDataURL(f);
  });

  onAuthStateChanged(auth, async (user)=>{
    if (!user){
      showWarn('Please log in first. Redirecting to login…');
      setTimeout(()=>{ window.location.href='hirer-login.html'; }, 1200);
      return;
    }
    try{
      const [adminFlag, profSnap] = await Promise.all([
        isAdmin(user.uid),
        getDoc(doc(db,'hirers',user.uid))
      ]);

      let data = {};
      if (profSnap.exists()) data = profSnap.data();
      else {
        data = {
          fullName: user.displayName || '',
          email: user.email || '',
          phone: user.phoneNumber || '',
          role: 'hirer',
          verificationStatus: 'unverified',
          photoURL: user.photoURL || ''
        };
        await setDoc(doc(db,'hirers',user.uid), { uid:user.uid, ...data, createdAt: serverTimestamp() }, { merge:true });
      }

      // keep any stored urls
      ['idFrontUrl','idBackUrl','selfieIdUrl','photoURL'].forEach(k=>{ if (data[k]) filePaths[k]=data[k]; });

      fillForm(data);
      setStatusBadge(data.verificationStatus || 'unverified');
      computeCompleteness(data);

      // rating aggregate
      mountHirerAggregate(user.uid);

      const verified = (data.verificationStatus === 'verified');
      setReadOnly(verified && !adminFlag);

      if (adminFlag){
        const btn = document.getElementById('adminUnlock');
        btn.classList.remove('hide');
        let unlocked = !verified;
        btn.addEventListener('click', ()=>{
          unlocked = !unlocked;
          setReadOnly(!unlocked);
          btn.textContent = unlocked ? '🔒 Lock (Admin)' : '🔓 Edit (Admin)';
        });
      }
    }catch(e){
      console.error(e);
      showWarn('Could not load your profile. Please refresh the page.');
    }
  });

  document.getElementById('saveDraft').addEventListener('click', async ()=>{
    const user = auth.currentUser;
    if (!user) return;
    await saveDraft(user.uid,false);
  });
  document.getElementById('requestVerify').addEventListener('click', async ()=>{
    const user = auth.currentUser;
    if (!user) return;
    const d = { ...collectForm(), ...filePaths };
    const basicOk   = d.fullName && d.email && d.phone;
    const addressOk = d.address1 && d.city && d.province && d.zip;
    const idOk      = d.idType && d.idNumber && (d.idFrontUrl || d.selfieIdUrl);
    const bizOk     = d.company || d.bizRegNo || d.website || d.fb || d.linkedin;

    if (!(basicOk && addressOk && (idOk || bizOk))){
      showWarn('Heads up: to reach 100%, complete Basic, Address, and either Identity or Business/Social proof. You can still submit now, but verification may be delayed.');
    }
    await saveDraft(user.uid,true);
  });
</script>
</body>
</html>
