<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Profile Preview</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --good-50:#eafaf1; --good-500:#16c47f; --good-600:#0fa86b; --good-800:#086e48;
    --warn-50:#fff9e7; --warn-200:#ffe6a3; --warn-500:#f5c85f;
    --fire-50:#fff1f0; --fire-600:#e12e15;
    --ink:#0E2A32; --muted:#5E6B74; --card:#fff; --line:#E6EDF2; --bg:#F6F9FB;
    --shadow: 0 18px 40px rgba(2,24,33,.08), 0 3px 10px rgba(2,24,33,.05);
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:24px; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; color:var(--ink);
    background:var(--bg);
  }

  .card{max-width:560px; margin:auto; background:var(--card); border:1px solid var(--line);
        border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
  header{padding:14px 16px; border-bottom:1px solid var(--line); font-weight:800; position:relative}
  .stamp{position:absolute; right:16px; top:12px}

  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
        font-size:.85rem; font-weight:700; border:1px solid var(--line); background:#fff; color:var(--ink)}
  .chip.good{border-color: color-mix(in oklab, var(--good-500) 40%, var(--line)); color:var(--good-800)}
  .chip.warn{border-color:var(--warn-200); background:var(--warn-50); color:#7a5a00}
  .chip.bad {border-color: color-mix(in oklab, var(--fire-600) 40%, var(--line)); background:var(--fire-50); color:#7a1d1d}
  .chip.addr{white-space:normal; max-width:100%;}

  .body{padding:16px}
  .name-row{display:flex; align-items:center; gap:10px; flex-wrap:wrap; font-weight:800; margin:0 0 10px}
  .grid{display:grid; grid-template-columns:120px 1fr; gap:14px; align-items:start}
  .leftcol{display:flex; flex-direction:column; align-items:center; gap:8px}
  .avatar{width:120px; height:120px; border-radius:18px; border:1px solid var(--line);
          background:linear-gradient(135deg, #c7f0d9, #ffffff); background-size:cover; background-position:center}

  .row{display:flex; gap:12px; flex-wrap:wrap; margin-top:8px}
  .muted{color:var(--muted); margin-top:10px; font-size:.92rem}

  /* indicators */
  .docRow{display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-top:8px}
  .docLabel{font-size:.8rem; font-weight:800; color:var(--muted); margin-right:2px}
  .badge{
    display:inline-flex; align-items:center; justify-content:center;
    padding:5px 8px; border-radius:10px; font-size:.78rem; font-weight:800;
    border:1px solid var(--line); min-width:44px; letter-spacing:.2px; user-select:none;
  }
  .badge.ok{ background:var(--good-600); color:#fff; border-color:color-mix(in oklab, var(--good-600) 70%, #ffffff 30%) }
  .badge.missing{ background:var(--fire-600); color:#fff; border-color:color-mix(in oklab, var(--fire-600) 70%, #ffffff 30%) }

  .loading{opacity:.6; filter:saturate(.7)}
</style>
</head>
<body>

<div class="card" aria-label="Profile Preview">
  <header>
    Profile Preview
    <span class="chip stamp" id="stamp">—</span>
  </header>

  <div class="body" id="cardBody">
    <div class="name-row">
      <div id="fullName" style="font-size:1.05rem">—</div>
      <span class="chip" id="chipAge">Age: —</span>
      <span class="chip" id="chipId">ID Unverified</span>
    </div>

    <div class="grid">
      <div class="leftcol">
        <div class="avatar" id="avatar" aria-hidden="true"></div>
        <span class="chip warn" id="chipUnder">Caution</span>
      </div>

      <div>
        <div class="row">
          <span class="chip addr" id="chipAddr">Address: —</span>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="chip"><strong>Score:</strong>&nbsp;<span id="scoreText">—</span> <span style="opacity:.6">/100</span></span>
          <span class="chip warn" id="chipStatus"><strong>Status:</strong>&nbsp;<span id="statusText">Caution</span></span>
        </div>

        <div class="docRow" id="docIndicatorsRow" aria-label="Document Indicators">
          <span class="docLabel">Docs:</span>
          <div class="indicators" id="docIndicators"></div>
        </div>

        <p class="muted" id="helperText">Sign in to load your profile instantly. Shareable link/QR lets inquirers view this snapshot with your consent.</p>
      </div>
    </div>
  </div>
</div>

<!-- Firebase (CDN ESM) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, onSnapshot, collection, getDocs
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // ---- Config ----
  const firebaseConfig = {
    apiKey: "AIzaSyDltLi2PXwafrQnCFG-hF-5ysY-wxaw6sQ",
    authDomain: "web-apps-41b38.firebaseapp.com",
    projectId: "web-apps-41b38",
    storageBucket: "web-apps-41b38.firebasestorage.app",
    messagingSenderId: "1082551975915",
    appId: "1:1082551975915:web:0cb80941c5a475d83063ae",
    measurementId: "G-EBPX4Q6M1Z"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);

  // --- helpers ---
  const $ = (id)=>document.getElementById(id);
  const bodyEl = $('cardBody');

  function setLoading(on){
    bodyEl.classList.toggle('loading', !!on);
    $('stamp').textContent = on ? 'Loading…' : 'Live';
  }
  function setAvatar(url){ if(url) $('avatar').style.backgroundImage = `url('${url}')`; }

  function updateStatusChips(tone, text){
    const under = $('chipUnder');
    const side  = $('chipStatus');
    const stTxt = $('statusText');
    stTxt.textContent = text;

    if(tone === 'green'){
      under.textContent = 'Safe'; under.className = 'chip good';
      side.className = 'chip good';
    }else if(tone === 'yellow'){
      under.textContent = 'Caution'; under.className = 'chip warn';
      side.className = 'chip warn';
    }else{
      under.textContent = 'Red flag'; under.className = 'chip bad';
      side.className = 'chip bad';
    }
  }

  function parseDOB(v){
    if(!v) return null;
    if (typeof v === 'string' || v instanceof String) {
      const d = new Date(v); return isNaN(d) ? null : d;
    }
    if (typeof v?.toDate === 'function') return v.toDate();
    if (typeof v?.seconds === 'number') return new Date(v.seconds*1000);
    if (typeof v === 'number') return new Date(v);
    return null;
  }
  function calcAge(d){
    if(!d) return null;
    const today = new Date();
    let age = today.getFullYear() - d.getFullYear();
    const m = today.getMonth() - d.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
    return age >= 0 && age < 150 ? age : null;
  }

  function formatAddress(u){
    const combined = u.address && String(u.address).trim();
    if (combined) return combined;
    const parts = [
      u.addressLine, u.barangay, u.city || u.municipality,
      u.province || u.region, u.zip, u.country || 'Philippines'
    ].filter(Boolean).map(String).map(s=>s.trim());
    return parts.join(', ') || '—';
  }

  // ---------- docs helpers ----------
  const INDICATOR_DEFS = [
    { code:'GIDF', label:'Government ID (Front)',   keys:['GIDF','govIdFront','idFront','id_front','frontId','front'] },
    { code:'GIDB', label:'Government ID (Back)',    keys:['GIDB','govIdBack','idBack','id_back','backId','back'] },
    { code:'SwID', label:'Selfie with ID',          keys:['SwID','selfieId','selfieWithId','selfie_id','idSelfie'] },
    { code:'PoA',  label:'Proof of Address',        keys:['PoA','proofAddress','addressProof','utilityBill','billProof'] },
    { code:'BC',   label:'Barangay Clearance',      keys:['BC','barangayClearance'] },
    { code:'PC',   label:'Police Clearance',        keys:['PC','policeClearance'] },
    { code:'NC',   label:'NBI Clearance',           keys:['NC','nbiClearance'] },
  ];

  function hasVal(v){
    if(!v) return false;
    if(Array.isArray(v)) return v.length>0;
    if(typeof v==='string') return !!v.trim();
    if(typeof v==='object') {
      if (v.url || v.link) return true;
      if (Array.isArray(v.urls) && v.urls.length>0) return true;
      return Object.keys(v).length>0;
    }
    return false;
  }

  function pickVal(keyList, usersDoc, docs){
    for(const k of keyList){
      if (hasVal(usersDoc?.docs?.[k])) return usersDoc.docs[k];
      if (hasVal(usersDoc?.verification?.[k])) return usersDoc.verification[k];
      if (hasVal(usersDoc?.documents?.[k])) return usersDoc.documents[k];
      if (hasVal(usersDoc?.[k])) return usersDoc[k];
      if (hasVal(docs?.[k])) return docs[k]; // optional legacy location
    }
    return null;
  }

  function presentMap(usersDoc, docs){
    const map = {};
    for (const def of INDICATOR_DEFS){
      map[def.code] = !!pickVal(def.keys, usersDoc||{}, docs||{});
    }
    return map;
  }

  function countPresent(pmap){
    return Object.values(pmap).reduce((a,b)=>a+(b?1:0),0);
  }

  function coreOK(pmap){
    return !!(pmap.GIDF && pmap.GIDB && pmap.SwID && pmap.PoA);
  }

  function phoneIsPH(p){ return /^\+63\d{10}$/.test((p||'').replace(/\s|-/g,'')); }

  function profileComplete(u){
    if(!u) return false;
    return !!(u.fullName && u.email && (u.dob || u.dateOfBirth || u.birthdate) && formatAddress(u) !== '—' && (u.photoURL || u.avatarUrl) && u.phone && phoneIsPH(u.phone));
  }

  function computeScoreAndStatus(usersDoc, docs, pmap){
    const totalDocs = countPresent(pmap);
    const core = coreOK(pmap);
    const profOK = profileComplete(usersDoc);

    let score = 0;
    if (profOK) score += 70;
    if (totalDocs >= 2) score += 20;
    if (core) score += 10;
    score = Math.max(0, Math.min(100, score));

    let statusText = 'Unverified';
    let tone = 'red';
    let idVerified = false;

    if (profOK && core){
      statusText = 'Fully Verified';
      tone = 'green';
      idVerified = true;
    } else if (totalDocs >= 2){
      statusText = 'Verified';
      tone = 'yellow';
      idVerified = true;
    }

    return { score, statusText, tone, idVerified };
  }

  function renderIndicators(pmap){
    const wrap = $('docIndicators');
    wrap.innerHTML = '';
    for (const def of INDICATOR_DEFS){
      const ok = !!pmap[def.code];
      const el = document.createElement('span');
      el.className = 'badge ' + (ok ? 'ok' : 'missing');
      el.textContent = def.code;
      el.title = `${def.label} — ${ok ? 'uploaded' : 'missing'}`;
      wrap.appendChild(el);
    }
  }

  function paint(usersDoc, result, pmap){
    $('fullName').textContent = usersDoc.fullName || usersDoc.name || usersDoc.displayName || usersDoc.email || 'Unnamed User';

    const age = calcAge(parseDOB(usersDoc.dateOfBirth || usersDoc.dob || usersDoc.birthdate));
    $('chipAge').textContent = `Age: ${age ?? '—'}`;

    const idChip = $('chipId');
    idChip.textContent = result.idVerified ? 'ID Verified' : 'ID Unverified';
    idChip.className = 'chip ' + (result.idVerified ? 'good' : 'bad');

    $('chipAddr').textContent = `Address: ${formatAddress(usersDoc)}`;
    $('scoreText').textContent = String(result.score);

    updateStatusChips(result.tone, result.statusText);
    setAvatar(usersDoc.photoURL || usersDoc.avatarUrl || '');

    renderIndicators(pmap);

    $('stamp').textContent = 'Live';
    $('helperText').textContent = 'This preview auto-updates from your document.';
  }

  // ----- DATA PIPELINE -----
  async function loadDocsLegacy(uid){
    // Optional legacy docs bucket (safe to remove if not used in your project)
    try{
      const flat = await getDoc(doc(db, "docs_upload", uid));
      if(flat.exists()) return flat.data();
      const items = await getDocs(collection(db, "docs_upload", uid, "items"));
      if(items.empty) return {};
      const merged = {};
      items.forEach(d=>{
        const data = d.data();
        const key = data.key || d.id;
        const val = data.value ?? data.url ?? data.urls ?? null;
        if(!key || !val) return;
        merged[key] = merged[key]
          ? (Array.isArray(merged[key]) ? merged[key].concat(val) : [merged[key]].concat(val))
          : val;
      });
      return merged;
    }catch{ return {}; }
  }

  let unsubUser = null;
  let cachedDocs = null;

  async function startUserListeners(uid){
    if (unsubUser) { try{ unsubUser(); }catch{} unsubUser = null; }

    setLoading(true);

    // Preload optional legacy docs (non-blocking)
    loadDocsLegacy(uid).then(d => { cachedDocs = d || {}; }).catch(()=>{ cachedDocs = {}; });

    // Real-time listener on users/{uid} — fires immediately with cached server data
    unsubUser = onSnapshot(doc(db, 'users', uid), (snap)=>{
      const data = snap.exists() ? snap.data() : null;
      if (!data){ setLoading(false); return; }
      const pmap = presentMap(data, cachedDocs || {});
      const result = computeScoreAndStatus(data, cachedDocs || {}, pmap);
      paint(data, result, pmap);
      setLoading(false);
    }, (err)=>{
      console.error('users listener error:', err);
      setLoading(false);
    });
  }

  // Prefer the AUTHENTICATED USER when logged in; if not signed in, fall back to ?worker
  const qs = new URLSearchParams(location.search);
  const qpWorker = qs.get('worker');

  onAuthStateChanged(auth, (user)=>{
    const uid = user?.uid || qpWorker || null;
    if (user?.uid) {
      // Logged-in: fetch immediately from users collection via onSnapshot
      startUserListeners(user.uid);
    } else if (qpWorker) {
      // Viewer mode for public preview: one-shot load (no auth)
      (async ()=>{
        setLoading(true);
        try{
          const snap = await getDoc(doc(db, 'users', qpWorker));
          const data = snap.exists() ? snap.data() : {};
          cachedDocs = await loadDocsLegacy(qpWorker);
          const pmap = presentMap(data, cachedDocs || {});
          const result = computeScoreAndStatus(data, cachedDocs || {}, pmap);
          paint(data, result, pmap);
        }catch(e){ console.error(e); }
        setLoading(false);
      })();
    } else {
      // No uid available
      $('helperText').textContent = 'Please sign in to load your profile.';
      $('stamp').textContent = '—';
    }
  });
</script>
</body>
</html>
