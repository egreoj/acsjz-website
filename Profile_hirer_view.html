<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beehire ‚Äî Worker Profile</title>

  <!-- Corporate font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#FFC107;          /* honey gold */
      --ink:#0E2A32;            /* deep navy */
      --muted:#6B7B84;
      --bg:#F6F9FC;
      --card:#ffffff;
      --line:#E6EDF2; --line-strong:#D7E1EA;
      --focus:#2C7BE5;
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#fff 0%, var(--bg) 70%); color:var(--ink);
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:40;
      background:var(--card); border-bottom:1px solid var(--line);
      box-shadow:0 2px 10px rgba(14,42,50,.04);
    }
    .nav{
      max-width:1100px; margin:0 auto; padding:14px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:12px; text-decoration:none}
    .brand-logo{width:42px; height:42px; object-fit:contain; filter:drop-shadow(0 2px 8px rgba(0,0,0,.06))}
    .brand-title{display:flex; flex-direction:column; line-height:1.1}
    .brand-title .name{font-weight:800; font-size:1.12rem; color:var(--ink)}
    .brand-title .tag{font-size:.8rem; color:var(--muted); font-weight:700; letter-spacing:.3px}

    /* Layout */
    .profile-wrapper{
      max-width:1100px; margin:26px auto; padding:0 20px;
      display:grid; grid-template-columns:320px 1fr; gap:26px;
    }
    @media (max-width: 900px){ .profile-wrapper{ grid-template-columns:1fr } }

    .sidebar{
      background:var(--card); border:1px solid var(--line); border-radius:16px; padding:22px; text-align:center;
      box-shadow:0 10px 24px rgba(14,42,50,.06);
    }
    .sidebar img{
      width:160px; height:160px; border-radius:50%; border:4px solid var(--brand); object-fit:cover; background:#fff;
      box-shadow:0 6px 16px rgba(14,42,50,.08);
    }

    /* Rating */
    .rating-row{ margin:10px 0 2px; display:flex; align-items:center; justify-content:center; gap:8px; }
    .stars{ display:inline-flex; line-height:1; user-select:none; gap:2px; }
    .star{ width:22px; height:22px; display:inline-block; position:relative; }
    .star svg{ width:22px; height:22px; display:block; }
    .star .fill{ position:absolute; inset:0; overflow:hidden; clip-path: inset(0 0 0 100%); }
    .star[data-fill="100"] .fill{ clip-path: inset(0 0 0 0%) }
    .star[data-fill="0"] .fill{ clip-path: inset(0 0 0 100%) }
    .rating-text{ font-size:.9em; color:var(--muted) }

    .verified-badge{
      color:#fff; padding:6px 12px; border-radius:999px; font-size:.85em; font-weight:800; display:inline-block; margin-top:8px;
      background:#9ca3af;  /* default neutral */
    }
    .progress-bar{ margin-top:10px; background:#f1f5f9; border-radius:999px; height:18px; overflow:hidden; border:1px solid var(--line); }
    .progress-fill{
      height:100%; background:linear-gradient(90deg,#f59e0b,#fbbf24,#84cc16);
      width:0; line-height:18px; text-align:center; font-size:.78em; font-weight:800; color:#111;
      transition: width .25s ease;
    }

    .contact-buttons{ margin-top:16px; display:grid; grid-template-columns:1fr; gap:10px; }
    .btn{
      width:100%; padding:12px; border-radius:12px; cursor:pointer; font-weight:800; font-size:.95em;
      background:#fff; border:1px solid var(--line-strong); color:var(--ink);
      transition: box-shadow .15s, border-color .15s, transform .06s ease-in;
    }
    .btn:hover{ border-color:var(--focus); box-shadow:0 6px 16px rgba(14,42,50,.08) }
    .btn:active{ transform: translateY(1px) }
    .btn-primary{
      background:var(--brand); border-color:var(--brand);
      box-shadow:0 8px 20px rgba(255,193,7,.28);
    }
    .btn-primary:hover{ filter:brightness(.98); box-shadow:0 12px 26px rgba(255,193,7,.38) }

    .main-content{ display:flex; flex-direction:column; gap:18px; }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:16px; padding:22px;
      box-shadow:0 10px 24px rgba(14,42,50,.06);
    }
    .card h3{
      margin:0 0 10px; color:var(--ink); font-size:1.05rem;
      padding-bottom:8px; border-bottom:1px dashed var(--line-strong);
    }
    .skill-badge{
      display:inline-block; background:#FFF6D6; color:#7A5B00; padding:6px 12px; border-radius:999px; margin:5px; font-size:.85em; font-weight:800; border:1px solid #F3D66A;
    }

    .document-list{ list-style:none; padding-left:0; margin:0 }
    .document-list li{
      background:#fbfdff; padding:12px; border-radius:12px; margin-bottom:10px; border:1px solid var(--line);
      display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap:wrap;
    }
    .document-list .actions{ display:flex; gap:8px; align-items:center; }
    .document-list button{ background:#fff; border:1px solid var(--line-strong); padding:8px 12px; border-radius:10px; cursor:pointer; font-size:.9em; font-weight:800; color:var(--ink) }
    .document-list button:hover{ border-color:var(--focus); box-shadow:0 6px 16px rgba(14,42,50,.06) }
    .document-list button[disabled]{ opacity:.5; cursor:not-allowed }
    .open-new{ text-decoration:none; font-weight:800; color:#0D6EFD }
    .open-new[aria-disabled="true"]{ color:#9aa7b1; pointer-events:none }

    .small-muted{ font-size:.85em; color:var(--muted) }

    /* Modal */
    .modal{ display:none; position:fixed; z-index:9999; inset:0; background-color:rgba(0,0,0,0.85); }
    .modal-content{ margin:40px auto; width:min(1000px,90%); height:min(85vh,900px); background:#fff; border-radius:14px; overflow:hidden; display:flex; flex-direction:column; }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--line); }
    .modal-body{ position:relative; flex:1; overflow:auto; background:#0b0b0b; display:flex; align-items:center; justify-content:center; }
    .modal-body embed, .modal-body img{ max-width:100%; max-height:100%; width:100%; height:100%; object-fit:contain; background:#0b0b0b; }
    .close{ color:#111; font-size:22px; font-weight:800; cursor:pointer; border:0; background:transparent; }
    .close:hover{ color:#dc2626; }
    .watermark{
      position:absolute; top:40%; left:10%; transform:rotate(-25deg);
      font-size:28px; color:rgba(230,230,230,.25); font-weight:800; white-space:nowrap; pointer-events:none;
    }

    /* Focus ring */
    button:focus, a:focus{ outline:none; box-shadow:0 0 0 3px rgba(44,123,229,.2) }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="nav">
      <a class="brand" href="beehiremain.html">
        <img class="brand-logo" src="BeeHire Logo.png" alt="Beehire logo">
        <span class="brand-title">
          <span class="name">Beehire CONNECT</span>
          <span class="tag">Worker Profile</span>
        </span>
      </a>
      <span style="padding:6px 10px; border:1px solid var(--line-strong); border-radius:999px; font-weight:800; font-size:.8rem; background:#fff; color:var(--ink)">Profile Viewer</span>
    </div>
  </header>

  <div class="profile-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
      <img id="profilePhoto" src="images/profile_placeholder.png" alt="Profile Photo">
      <h2 id="workerName" style="margin:12px 0 6px">‚Äî</h2>

      <!-- ‚≠ê Rating -->
      <div class="rating-row">
        <div id="stars" class="stars" aria-label="Worker rating" title="Rating"></div>
        <span id="ratingText" class="rating-text">No ratings yet</span>
      </div>

      <!-- Category ‚Ä¢ Location -->
      <p style="margin:6px 0 0; color:var(--muted)"><span id="skillCategory">‚Äî</span> ‚Ä¢ <span id="locationText">‚Äî</span></p>

      <span class="verified-badge" id="verifiedBadge">Not Verified</span>
      <div class="progress-bar" aria-hidden="true">
        <div class="progress-fill" id="progressFill">Not Verified</div>
      </div>

      <div class="contact-buttons">
        <button class="btn btn-primary" id="hireBtn">Hire Me</button>
      </div>
    </aside>

    <!-- Main Content -->
    <section class="main-content">
      <div class="card">
        <h3>Personal Information</h3>
        <p><b>Age:</b> <span id="ageTxt">‚Äî</span></p>
        <p><b>Gender:</b> <span id="genderTxt">‚Äî</span></p>
        <p><b>Civil Status:</b> <span id="statusTxt">‚Äî</span></p>
        <p><b>Email:</b> <span id="emailTxt">‚Äî</span></p>
        <p><b>Phone:</b> <span id="phoneTxt">‚Äî</span></p>
        <p><b>Location:</b> <span id="locationPI">‚Äî</span></p>
      </div>

      <div class="card">
        <h3>About Me</h3>
        <p id="bioTxt">‚Äî</p>
      </div>

      <div class="card">
        <h3>Skills</h3>
        <div id="skillsWrap"></div>
      </div>

      <div class="card">
        <h3>Service Details</h3>
        <p><b>Rate:</b> <span id="rateTxt">‚Äî</span></p>
        <p><b>Availability:</b> <span id="availTxt">‚Äî</span></p>
      </div>

      <div class="card">
        <h3>Uploaded Documents</h3>
        <ul class="document-list" id="docList"></ul>
        <div class="small-muted">Note: Some documents may open as images; PDFs will render in a viewer.</div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="docModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="docTitle">
    <div class="modal-content">
      <div class="modal-header">
        <strong id="docTitle">Document</strong>
        <div style="display:flex;align-items:center;gap:12px;">
          <a id="openNewTab" class="open-new" href="#" target="_blank" rel="noopener">Open in new tab ‚Üó</a>
          <button class="close" id="closeBtn" aria-label="Close">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="watermark" id="dynamicWatermark"></div>
        <embed id="docPdf" src="" type="application/pdf" style="display:none;">
        <img id="docImg" src="" alt="Document" style="display:none;">
      </div>
    </div>
  </div>

  <!-- Non-module: modal + light protections -->
  <script>
    // Simple global opener used by module code
    window.openDoc = function(url, title, workerName, workerEmail){
      const modal = document.getElementById("docModal");
      const pdf = document.getElementById("docPdf");
      const img = document.getElementById("docImg");
      const wm  = document.getElementById("dynamicWatermark");
      const openNew = document.getElementById("openNewTab");
      const docTitle = document.getElementById("docTitle");

      const safeUrl = (url||"").startsWith("http://") ? url.replace("http://","https://") : (url||"");
      docTitle.textContent = title || "Document";
      openNew.href = safeUrl;

      const isPdf = /\.pdf(\?|#|$)/i.test(safeUrl);
      if (isPdf) {
        img.style.display = "none"; img.src = "";
        pdf.style.display = "block"; pdf.src = safeUrl;
      } else {
        pdf.style.display = "none"; pdf.src = "";
        img.style.display = "block"; img.src = safeUrl;
      }

      const name = (workerName || "Beehire Worker").trim();
      const email = (workerEmail || "").trim();
      wm.textContent = `${name}${email ? " | " + email : ""} ‚Äî Beehire Verified Document`;

      modal.style.display = "block";
    };

    function closeModal(){
      const modal = document.getElementById("docModal");
      const pdf = document.getElementById("docPdf");
      const img = document.getElementById("docImg");
      modal.style.display = "none";
      pdf.src = ""; img.src = "";
    }
    document.getElementById("closeBtn").addEventListener("click", closeModal);
    window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    // Light content protection (note: can be bypassed; don't rely for real security)
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key.toLowerCase() === 'p') { e.preventDefault(); alert("Printing disabled."); }
    });
  </script>

  <!-- Firebase: fetch details + rating + docs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkkVvflDza_lmFmUmsgUQv6iOiMW3y9bc",
        authDomain: "myapp-96865.firebaseapp.com",
        databaseURL: "https://myapp-96865-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "myapp-96865",
        // If Storage misbehaves, try: "myapp-96865.appspot.com"
        storageBucket: "myapp-96865.firebasestorage.app",
        messagingSenderId: "217431866794",
        appId: "1:217431866794:web:965d02cc01d12ae555ffd3",
        measurementId: "G-1T4M9PE1GD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const money = (v)=>!v ? "" : (/^\d+(\.\d+)?$/.test(v) ? `‚Ç±${v} per hour` : v);
    const urlUid = new URLSearchParams(location.search).get("uid");

    /* ‚≠ê STARS */
    function starSvg(outline=false){
      return outline
        ? `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3.6l2.7 5.47 6.03.88-4.36 4.25 1.03 5.99L12 17.9l-5.4 2.84 1.03-5.99L3.27 9.95l6.03-.88L12 3.6z" fill="none" stroke="#FFC107" stroke-width="1.5"/></svg>`
        : `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3.6l2.7 5.47 6.03.88-4.36 4.25 1.03 5.99L12 17.9l-5.4 2.84 1.03-5.99L3.27 9.95l6.03-.88L12 3.6z" fill="#FFC107"/></svg>`;
    }
    function renderStars(avg){
      const container = $("stars"); container.innerHTML = "";
      const pct = (n)=> Math.max(0, Math.min(100, n*20));
      for (let i=1;i<=5;i++){
        const percent = Math.max(0, Math.min(100, pct(avg) - (i-1)*100));
        const el = document.createElement("span");
        el.className = "star";
        el.dataset.fill = percent >= 100 ? "100" : (percent <= 0 ? "0" : String(percent));
        el.innerHTML = `${starSvg(true)}<span class="fill" style="clip-path: inset(0 0 0 ${100 - percent}%)">${starSvg(false)}</span>`;
        container.appendChild(el);
      }
    }
    function setRatingUI(avg, count){
      if (!avg || isNaN(avg)) {
        renderStars(0);
        $("ratingText").textContent = "No ratings yet";
      } else {
        const rounded = Math.round(avg*10)/10;
        renderStars(rounded);
        $("ratingText").textContent = `${rounded} ¬∑ ${count||0} review${(count||0)===1?"":"s"}`;
      }
    }

    /* Verification helpers */
    function computeVerificationStatus(data, docsCount){
      const raw = (data?.verificationStatus || '').toString().trim().toLowerCase();
      if (raw) {
        if (raw === 'verified' || raw === 'approved') return 'Verified';
        if (raw === 'pending' || raw === 'in review' || raw === 'review' || raw === 'under review') return 'Pending Review';
        if (raw === 'rejected' || raw === 'declined') return 'Rejected';
        if (raw === 'unverified') return 'Not Verified';
      }
      if (data?.verified === true) return 'Verified';
      if (docsCount > 0) return 'Pending Review';
      return 'Not Verified';
    }
    function applyVerificationUI(status){
      const badge = $("verifiedBadge");
      const fill = $("progressFill");
      const colors = { 'Verified':'#16a34a', 'Pending Review':'#d97706', 'Not Verified':'#9ca3af', 'Rejected':'#dc2626' };
      const pct = { 'Not Verified':0, 'Pending Review':75, 'Verified':100, 'Rejected':0 };
      badge.textContent = status;
      badge.style.background = colors[status] || '#9ca3af';
      fill.style.width = (pct[status] ?? 0) + '%';
      fill.textContent = status;
    }

    function buildDocList(data, workerName, workerEmail){
      const list = $("docList");
      list.innerHTML = "";
      const entries = [
        { key: "validIdUrl",          label: "üìÑ Valid ID" },
        { key: "policeClearanceUrl",  label: "üìÑ Police Clearance" },
        { key: "barangayClearanceUrl",label: "üìÑ Barangay Clearance" },
        { key: "tesdaCertificateUrl", label: "üìÑ TESDA Certificate" },
        { key: "nbiClearanceUrl",     label: "üìÑ NBI Clearance" }
      ];
      const toHttps = (u)=>!u ? "" : (u.startsWith("http://") ? u.replace("http://","https://") : u);

      entries.forEach(e=>{
        const url = toHttps(data?.[e.key] || "");
        const li = document.createElement("li");

        const left = document.createElement("div");
        left.textContent = e.label;

        const actions = document.createElement("div");
        actions.className = "actions";

        const btn = document.createElement("button");
        btn.textContent = "View";
        if (url) {
          btn.onclick = ()=> window.openDoc(url, e.label.replace("üìÑ ",""), workerName, workerEmail);
        } else {
          btn.disabled = true; btn.title = "Not uploaded";
        }

        const link = document.createElement("a");
        link.className = "open-new";
        link.textContent = "Open ‚Üó";
        link.href = url || "#";
        link.target = "_blank"; link.rel = "noopener";
        if (!url) link.setAttribute("aria-disabled","true");

        actions.appendChild(btn);
        actions.appendChild(link);
        li.appendChild(left);
        li.appendChild(actions);
        list.appendChild(li);
      });

      return entries.reduce((n,e)=> n + (data?.[e.key] ? 1 : 0), 0);
    }

    async function loadDocsFromSub(uid, data){
      const list = $("docList");
      const sub = await getDocs(collection(doc(db, "workers", uid), "documents"));
      let count = 0;
      sub.docs.forEach(d=>{
        const it = d.data(); if (!it || !it.url) return;
        count++;
        const url = it.url.startsWith("http://") ? it.url.replace("http://","https://") : it.url;
        const li = document.createElement("li");
        li.innerHTML = `
          ${it.name ? "üìÑ " + it.name : "üìÑ Document"}
          <div class="actions">
            <button>View</button>
            <a class="open-new" href="${url}" target="_blank" rel="noopener">Open ‚Üó</a>
          </div>`;
        const btn = li.querySelector("button");
        btn.onclick = ()=> window.openDoc(url, it.name || "Document", data?.fullName || "", data?.email || "");
        list.appendChild(li);
      });
      return count;
    }

    async function computeRatingFromSub(uid){
      const paths = ["reviews","ratings"];
      let total = 0, count = 0;
      for (const p of paths){
        const snap = await getDocs(collection(doc(db,"workers",uid), p));
        snap.forEach(it=>{
          const r = it.data()?.rating;
          if (typeof r === "number" && r >= 1 && r <= 5){ total += r; count += 1; }
        });
        if (count>0) break;
      }
      return { avg: count>0 ? total/count : 0, count };
    }

    async function loadProfile(uid){
      const ref = doc(db, "workers", uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        setRatingUI(0,0);
        applyVerificationUI('Not Verified');
        return;
      }
      const d = snap.data();

      // Name/category/location
      $("workerName").textContent = d.fullName || d.name || d.username || "‚Äî";
      $("skillCategory").textContent = d.skillCategory || "‚Äî";
      $("locationText").textContent = d.location || "‚Äî";
      $("locationPI").textContent = d.location || "‚Äî";

      // Photo
      const rawImg = d.profileImageUrl || d.photoUrl || "";
      $("profilePhoto").src = rawImg ? (rawImg.startsWith("http://") ? rawImg.replace("http://","https://") : rawImg) : "images/profile_placeholder.png";

      // Personal
      $("ageTxt").textContent = (typeof d.age === "number") ? d.age : "‚Äî";
      $("genderTxt").textContent = d.gender || "‚Äî";
      $("statusTxt").textContent = d.status || "‚Äî";
      $("emailTxt").textContent = d.email || "‚Äî";
      $("phoneTxt").textContent = d.phone || "‚Äî";

      // About
      $("bioTxt").textContent = d.bio || "‚Äî";

      // Skills
      const wrap = $("skillsWrap"); wrap.innerHTML = "";
      if (Array.isArray(d.skills) && d.skills.length){
        d.skills.forEach(s=>{
          const span = document.createElement("span");
          span.className = "skill-badge";
          span.textContent = s;
          wrap.appendChild(span);
        });
      }

      // Service
      $("rateTxt").textContent = d.pricing ? money(d.pricing) : "‚Äî";
      $("availTxt").textContent = d.availability || "‚Äî";

      // Initial status
      let docsTotal = 0;
      applyVerificationUI(computeVerificationStatus(d, 0));

      // Rating
      const aggAvg = d.ratingAvg ?? d.rating ?? d.ratingAverage;
      const aggCount = d.ratingCount ?? d.reviewsCount ?? d.ratingsCount;
      if (typeof aggAvg === "number" && typeof aggCount === "number"){
        setRatingUI(aggAvg, aggCount);
      } else {
        const { avg, count } = await computeRatingFromSub(uid);
        setRatingUI(avg, count);
      }

      // Docs (top-level + subcollection)
      docsTotal += buildDocList(d, d.fullName || "", d.email || "");
      docsTotal += await loadDocsFromSub(uid, d).catch(()=>0);

      // Final status after docs
      applyVerificationUI(computeVerificationStatus(d, docsTotal));
    }

    // Hire CTA (you can wire to chat or booking)
    $("hireBtn").addEventListener("click", ()=>{
      const uid = urlUid || "unknown";
      location.href = `hire_request.html?uid=${encodeURIComponent(uid)}`;
    });

    onAuthStateChanged(auth, async (user)=>{
      const targetUid = urlUid || (user && user.uid);
      await loadProfile(targetUid);
    });
  </script>
</body>
</html>
