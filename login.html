<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Beehire — Login</title>

  <!-- Corporate font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0E2A32; --muted:#6B7B84; --bg:#F7F9FB; --card:#fff;
      --brand:#FFC107; --line:#E6EDF2; --focus:#2C7BE5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink);
      background:linear-gradient(180deg,#fff 0%,#F8FBFF 60%,#F2F7FB 100%)
    }

    header{position:sticky;top:0;z-index:20;background:var(--card);border-bottom:1px solid var(--line);box-shadow:0 2px 12px rgba(0,0,0,.04)}
    .nav{max-width:1100px;margin:0 auto;padding:16px 20px;display:flex;align-items:center;gap:12px;justify-content:center}
    .nav img{width:40px;height:40px;object-fit:contain}
    .nav .title{font-weight:800;letter-spacing:.2px}

    .wrap{max-width:520px;margin:38px auto;padding:0 18px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:26px;box-shadow:0 14px 30px rgba(14,42,50,.08)}
    h2{margin:0 0 8px}
    .sub{margin:0 0 16px;color:var(--muted)}

    form{display:flex;flex-direction:column;gap:12px}
    label{font-weight:800;font-size:.95rem}
    .input{display:flex;align-items:center;gap:10px;border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:#fff;transition:border-color .15s, box-shadow .15s}
    .input:focus-within{border-color:var(--focus);box-shadow:0 0 0 3px rgba(44,123,229,.15)}
    .input input{border:0;outline:none;width:100%;font-size:1rem;background:transparent;color:var(--ink)}

    .btn{margin-top:6px;background:var(--brand);color:#111;padding:12px 16px;border:0;border-radius:12px;font-size:1rem;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(255,193,7,.28);transition:filter .15s,transform .06s,box-shadow .15s}
    .btn:hover{filter:brightness(.98);box-shadow:0 12px 26px rgba(255,193,7,.38)}
    .btn:active{transform:translateY(1px)}

    .divider{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:12px;margin:18px 0 10px;color:var(--muted);font-weight:700;letter-spacing:.15px}
    .divider::before,.divider::after{content:"";height:1px;background:var(--line);display:block}

    .oauth{display:flex;flex-direction:column;gap:10px}
    .btn-ghost{background:#fff;border:1px solid var(--line);color:var(--ink);font-weight:700;padding:12px 14px;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:background .15s, box-shadow .15s, border-color .15s}
    .btn-ghost:hover{background:#FAFCFF;border-color:#D8E3EE;box-shadow:0 6px 16px rgba(14,42,50,.06)}

    .hint{font-size:.9rem;color:var(--muted)}
    .register{text-align:center;margin-top:12px}
    .register a{color:#0D6EFD;text-decoration:none;font-weight:700}
    .register a:hover{text-decoration:underline}

    .alert{display:none;border-radius:10px;padding:10px 12px;margin:8px 0;font-weight:600}
    .alert.err{display:block;background:#FEF2F2;border:1px solid #FECACA;color:#991b1b}
    .alert.ok{display:block;background:#ECFEFF;border:1px solid #A5F3FC;color:#075985}

    .loading{opacity:.6;pointer-events:none}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <img src="BeeHire Logo.png" alt="Beehire logo">
      <div class="title">Beehire CONNECT — Login</div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel" aria-labelledby="login-title">
      <h2 id="login-title">Welcome back</h2>
      <p class="sub">Sign in to manage your profile, documents, and bookings.</p>

      <div id="msg" class="alert"></div>

      <form id="loginForm" novalidate>
        <label for="identifier">Username / Phone / Email</label>
        <div class="input">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5a5 5 0 0 0 5 5m0 2c-4 0-8 2-8 5v1h16v-1c0-3-4-5-8-5"/></svg>
          <input type="text" id="identifier" placeholder="Enter username, phone or email" required autocapitalize="none" autocomplete="username" />
        </div>

        <label for="password">Password</label>
        <div class="input">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 17a2 2 0 0 1-2-2a2 2 0 1 1 2 2m6-6h-1V8a5 5 0 0 0-10 0v3H6a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2M8 8a4 4 0 0 1 8 0v3H8Z"/></svg>
          <input type="password" id="password" placeholder="Enter password" required autocomplete="current-password" />
        </div>

        <button type="submit" id="loginBtn" class="btn">Sign in</button>
        <div class="hint">Tip: Enter your <b>username</b> or <b>phone</b> and we’ll look up your email in <b>users</b>.</div>
      </form>

      <div class="divider">or continue with</div>

      <div class="oauth">
        <button class="btn-ghost" id="googleBtn" aria-label="Continue with Google">
          <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true"><path fill="#FFC107" d="M43.6 20.5H42v-.1H24v7h11.3C33.9 31 29.4 34 24 34c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.3 0 6.3 1.2 8.6 3.3l5-5C34.7 3.1 29.6 1 24 1C11.8 1 2 10.8 2 23s9.8 22 22 22c12.1 0 21.7-8.8 21.7-22c0-1.4-.1-2.7-.3-4.5z"/><path fill="#FF3D00" d="M6.3 14.7l5.7 4.2C13.8 15.2 18.5 12 24 12c3.3 0 6.3 1.2 8.6 3.3l5-5C34.7 6.1 29.6 4 24 4C15 4 7.5 9.3 6.3 14.7z"/><path fill="#4CAF50" d="M24 46c5.3 0 10.2-1.8 14-4.9l-6.5-5c-2 1.4-4.7 2.3-7.5 2.3c-5.4 0-9.9-3.6-11.5-8.5l-5.7 4.4C9 41.6 15.9 46 24 46z"/><path fill="#1976D2" d="M43.6 20.5H42v-.1H24v7h11.3c-1.3 3.2-4.6 5.6-8.3 5.6c-2.5 0-4.8-.9-6.6-2.5l-5.7 4.4C17.1 38.4 20.3 40 24 40c12.1 0 21.7-8.8 21.7-22c0-1.4-.1-2.7-.3-4.5z"/></svg>
          Continue with Google
        </button>
      </div>

      <p class="register">Don’t have an account? <a href="registration.html">Register Here</a></p>
    </section>
  </main>

  <!-- Firebase JS SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged,
      GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult
    } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkkVvflDza_lmFmUmsgUQv6iOiMW3y9bc",
      authDomain: "myapp-96865.firebaseapp.com",
      databaseURL: "https://myapp-96865-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "myapp-96865",
      storageBucket: "myapp-96865.firebasestorage.app",
      messagingSenderId: "217431866794",
      appId: "1:217431866794:web:965d02cc01d12ae555ffd3",
      measurementId: "G-1T4M9PE1GD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- UI helpers ---
    const msg = document.getElementById("msg");
    const form = document.getElementById("loginForm");
    const googleBtn = document.getElementById("googleBtn");

    function show(type, text){
      msg.className = "alert " + (type === "err" ? "err" : "ok");
      msg.textContent = text;
    }
    function clearMsg(){ msg.className="alert"; msg.textContent=""; }
    function setLoading(on){ document.querySelector('.panel').classList.toggle('loading', !!on); }

    // --- small utils ---
    const asString = (v, fb="") => {
      if (v===null || v===undefined) return fb;
      if (typeof v === "string") return v;
      try { return String(v); } catch { return fb; }
    };
    const normEmail = (e)=> asString(e).trim().toLowerCase();
    const onlyDigits = (s)=> asString(s).replace(/\D/g,'');
    const normPhone = (p)=> {
      // Accept +63XXXXXXXXXX, 09XXXXXXXXX, or 9XXXXXXXXX → compare on digits only
      const d = onlyDigits(p);
      if (d.startsWith('63') && d.length>=12) return '+63' + d.slice(2,12);
      if (d.startsWith('0')  && d.length>=11) return '+63' + d.slice(1,11);
      if (d.length===10 && d.startsWith('9')) return '+63' + d; // store as +63
      return p; // fallback untouched
    };

    // --- Upsert user doc in USERS (no roles) ---
    async function upsertUserProfile(user, source = "password") {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      const provider = (user.providerData && user.providerData[0]?.providerId) || source || "password";

      const payload = {
        uid: user.uid,
        email: user.email || null,
        displayName: user.displayName || null,
        fullName: user.displayName || null,
        profileImageUrl: user.photoURL || null,
        phone: user.phoneNumber || null,
        provider,
        lastLogin: serverTimestamp()
      };
      if (!snap.exists()) {
        payload.createdAt = serverTimestamp();
        payload.verificationStatus = "unverified";
      }
      await setDoc(ref, payload, { merge: true });
      return ref;
    }

    // --- After login go to unified profile page ---
    async function goToHome(){
      window.location.href = "profile_view.html";
    }

    // --- Resolve username/phone/email → email (from USERS) ---
    async function resolveEmailFromUsers(identifierRaw){
      const usersRef = collection(db, "users");
      const id = identifierRaw.trim();

      // If looks like email, use directly
      if (id.includes("@")) return normEmail(id);

      // Try username
      let s = await getDocs(query(usersRef, where("username", "==", id.toLowerCase())));
      if (!s.empty) return normEmail(s.docs[0].data().email);

      // Try phone (normalize both ways)
      const phoneVariants = Array.from(new Set([
        id,
        onlyDigits(id),
        normPhone(id)
      ])).filter(Boolean);

      for (const pv of phoneVariants) {
        s = await getDocs(query(usersRef, where("phone", "==", pv)));
        if (!s.empty) return normEmail(s.docs[0].data().email);
      }

      // Last: email field equal to id (in case they typed email w/o @ or weird)
      s = await getDocs(query(usersRef, where("email","==", id.toLowerCase())));
      if (!s.empty) return normEmail(s.docs[0].data().email);

      return null;
    }

    // --- Email/Password sign-in ---
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      clearMsg(); setLoading(true);
      const identifier = document.getElementById("identifier").value.trim();
      const password = document.getElementById("password").value;
      try{
        const email = identifier.includes("@")
          ? normEmail(identifier)
          : await resolveEmailFromUsers(identifier);

        if (!email){
          show("err","Account not found in users. Please check your input or register first.");
          return;
        }
        const cred = await signInWithEmailAndPassword(auth, email, password);
        await upsertUserProfile(cred.user, "password");
        await goToHome();
      }catch(err){
        console.error(err);
        show("err","Login failed: " + (err.message || err.code));
      }finally{ setLoading(false); }
    });

    // --- Google OAuth (popup with redirect fallback) ---
    async function signInWithGoogle(){
      clearMsg(); setLoading(true);
      try{
        const provider = new GoogleAuthProvider();
        const r = await signInWithPopup(auth, provider);
        await upsertUserProfile(r.user, provider.providerId);
        await goToHome();
      }catch(err){
        const code = String(err?.code||"");
        const msgText = String(err?.message||"");
        if (code.includes("auth/unauthorized-domain")){
          show("err","Unauthorized domain for Google sign-in. Add this domain in Firebase Auth → Settings → Authorized domains.");
        }else if (code.includes("popup-blocked") || msgText.toLowerCase().includes("popup")){
          const provider = new GoogleAuthProvider();
          await signInWithRedirect(auth, provider);
          return;
        }else{
          show("err", msgText || "Google sign-in failed.");
        }
      }finally{ setLoading(false); }
    }

    getRedirectResult(auth).then(async (res)=>{
      if (res?.user){
        await upsertUserProfile(res.user, res.providerId || res._tokenResponse?.providerId || "redirect");
        await goToHome(res.user);
      }
    }).catch(e=>console.warn("redirect result", e));

    googleBtn.addEventListener("click", signInWithGoogle);

    // --- Auto-redirect if already signed in ---
    onAuthStateChanged(auth, async (user)=>{
      if (!user) return;
      setLoading(true);
      try{
        await upsertUserProfile(user, user.providerData?.[0]?.providerId || "session");
        await goToHome();
      }finally{ setLoading(false); }
    });
  </script>
</body>
</html>
