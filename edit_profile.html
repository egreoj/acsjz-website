<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Beehire — Edit Profile</title>

  <!-- Corporate font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#FFC107; --ink:#0E2A32; --muted:#6B7B84; --bg:#F6F9FC; --card:#ffffff;
      --line:#E6EDF2; --line-strong:#D7E1EA; --focus:#2C7BE5;
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink); background:linear-gradient(180deg,#fff 0%, var(--bg) 70%);
    }

    header{position:sticky; top:0; z-index:40; background:var(--card); border-bottom:1px solid var(--line);
      box-shadow:0 2px 10px rgba(14,42,50,.04)}
    .nav{max-width:1100px; margin:0 auto; padding:14px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:12px; text-decoration:none}
    .brand-logo{width:42px; height:42px; object-fit:contain; filter:drop-shadow(0 2px 8px rgba(0,0,0,.06))}
    .brand-title{display:flex; flex-direction:column; line-height:1.1}
    .brand-title .name{font-weight:800; font-size:1.12rem; color:var(--ink)}
    .brand-title .tag{font-size:.8rem; color:var(--muted); font-weight:700; letter-spacing:.3px}
    .badge{padding:6px 10px; border:1px solid var(--line-strong); border-radius:999px; color:var(--ink); font-size:.8rem; font-weight:800; background:#fff}

    .container{max-width:1100px; background:var(--card); margin:26px auto 34px; padding:26px; border-radius:18px;
      border:1px solid var(--line); box-shadow:0 12px 28px rgba(14,42,50,.08)}
    h2{margin:0 0 18px; text-align:center; color:var(--ink); font-size:1.35rem; letter-spacing:.2px}

    form{display:flex; flex-direction:column; gap:20px}
    label{font-weight:800; margin-bottom:6px; font-size:.95rem}
    .row{display:flex; gap:18px; flex-wrap:wrap}
    .row > div{flex:1; min-width:260px}

    .input{display:flex; align-items:center; gap:10px; border:1px solid var(--line); border-radius:12px; padding:12px 14px; background:#fff; transition:border-color .15s, box-shadow .15s}
    .input:focus-within{border-color:var(--focus); box-shadow:0 0 0 3px rgba(44,123,229,.15)}
    .input input, .input select, .input textarea{outline:none; border:0; width:100%; font-size:1rem; background:transparent; color:var(--ink)}
    textarea{resize:vertical}

    .profile-photo{text-align:center; display:grid; place-items:center; gap:10px}
    .profile-photo img{width:150px; height:150px; border-radius:50%; object-fit:cover; border:5px solid var(--brand); background:#fff; box-shadow:0 6px 16px rgba(14,42,50,.08)}

    .skills-editor{display:grid; grid-template-columns: 1.1fr 1.2fr auto; gap:10px; align-items:center}
    @media (max-width: 720px){ .skills-editor{ grid-template-columns:1fr } }
    .chips{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{display:inline-flex; align-items:center; gap:8px; background:#fff; border:1px solid var(--line-strong); color:#111;
      padding:6px 10px; border-radius:999px; box-shadow:0 1px 2px rgba(0,0,0,.04); font-weight:700; font-size:.9rem}
    .chip .x{cursor:pointer; font-weight:800}
    .chip .star{cursor:pointer; filter:grayscale(1)}
    .chip.primary{border-color:#F3D66A; background:#FFF6D6}
    .chip.primary .star{filter:grayscale(0)}
    .hint{font-size:.9rem; color:var(--muted)}

    .btn{background:var(--brand); color:#111; padding:12px 16px; border:0; border-radius:12px; font-size:1rem; font-weight:800; cursor:pointer;
      align-self:center; width:auto; min-width:160px; box-shadow:0 8px 20px rgba(255,193,7,.28); transition:transform .06s, box-shadow .15s, filter .15s}
    .btn:hover{filter:brightness(.98); box-shadow:0 12px 26px rgba(255,193,7,.38)}
    .btn:active{transform:translateY(1px)}

    .docs{margin-top:28px; border-top:1px dashed var(--line-strong); padding-top:18px}
    .docs h3{margin:0 0 12px; text-align:center; font-size:1.1rem}
    .doc-item{display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; margin-bottom:12px; background:#fbfdff; border:1px solid var(--line); border-radius:12px; padding:12px}
    .doc-meta{display:flex; flex-direction:column; gap:8px}
    .doc-title{font-weight:800; color:#222; display:flex; align-items:center; gap:8px}
    .doc-actions{display:flex; gap:8px; align-items:center}
    .doc-actions a{text-decoration:none; color:#0D6EFD; font-weight:800}
    .doc-note{font-size:.9rem; color:var(--muted)}
    .status{font-size:.9rem; color:var(--muted)}
    .ico{flex:0 0 18px; opacity:.7}

    /* Phone input with fixed +63 prefix */
    .phone-wrap{display:flex; align-items:center; gap:8px}
    .phone-wrap .prefix{
      flex:0 0 auto; padding:6px 10px; border:1px solid var(--line-strong); border-radius:10px;
      background:#f9fbff; font-weight:800; color:#0b1520; letter-spacing:.2px
    }
    .phone-wrap input{letter-spacing:.4px}
  </style>
</head>
<body>

  <header>
    <div class="nav">
      <a class="brand" href="beehiremain.html">
        <img class="brand-logo" src="BeeHire Logo.png" alt="Beehire logo">
        <span class="brand-title">
          <span class="name">Beehire CONNECT</span>
          <span class="tag">Edit Profile</span>
        </span>
      </a>
      <span class="badge">Profile</span>
    </div>
  </header>

  <div class="container">
    <h2>Edit Your Profile</h2>

    <form id="profileForm" novalidate>
      <!-- Photo -->
      <div class="profile-photo">
        <img id="profileImage" src="https://via.placeholder.com/150" alt="Profile Photo">
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center">
          <button type="button" id="btnUploadPhoto" class="btn">Upload Photo</button>
          <div class="input" style="width:min(420px,100%)">
            <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M9 2l1.5 2H14l1.5-2H18l2 3h2v15a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5h2l2-3h3Zm3 16a5 5 0 1 0 0-10a5 5 0 0 0 0 10Zm0-2a3 3 0 1 1 0-6a3 3 0 0 1 0 6Z"/></svg>
            <input type="file" id="photoUpload" accept="image/*">
          </div>
        </div>
        <div class="hint">Tip: Use the <b>Upload Photo</b> button to send directly to Cloudinary.</div>
      </div>

      <!-- Identity -->
      <div class="row">
        <div>
          <label for="fullname">Full Name</label>
          <div class="input"><input type="text" id="fullname" placeholder="Juan D. Dela Cruz"></div>
        </div>
        <div>
          <label for="birthdate">Birthdate</label>
          <div class="input"><input type="date" id="birthdate"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="age">Age</label>
          <div class="input"><input type="number" id="age" readonly></div>
        </div>
        <div>
          <label for="gender">Gender</label>
          <div class="input">
            <select id="gender">
              <option>Male</option><option>Female</option><option>Other</option>
            </select>
          </div>
        </div>
        <div>
          <label for="status">Civil Status</label>
          <div class="input">
            <select id="status">
              <option>Single</option><option>Married</option><option>Separated</option><option>Widowed</option>
            </select>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="phone10">Phone Number</label>
          <div class="input phone-wrap">
            <span class="prefix">+63</span>
            <input
              type="tel"
              id="phone10"
              inputmode="numeric"
              placeholder="9xxxxxxxxx"
              maxlength="10"
              pattern="9[0-9]{9}"
              aria-label="Philippine mobile number, 10 digits starting with 9"
            />
          </div>
          <div class="hint">PH mobile: <b>+63</b> <b>9xxxxxxxxx</b> (enter only the 10 digits).</div>
        </div>
        <div>
          <label for="email">Email Address</label>
          <div class="input"><input type="email" id="email" readonly></div>
        </div>
        <div>
          <label for="location">Location</label>
          <div class="input"><input type="text" id="location" placeholder="City, Province"></div>
        </div>
      </div>

      <!-- Skills -->
      <div class="row">
        <div style="flex:2">
          <label>Skills (choose multiple or add custom)</label>
          <div class="skills-editor">
            <div class="input">
              <select id="skillPreset" aria-label="Skill preset">
                <option value="">Select preset…</option>
                <option>Electrician</option><option>Plumber</option><option>Carpenter</option>
                <option>Mechanic</option><option>Cleaner</option><option>Driver</option>
                <option>Painter</option><option>Cook</option><option>Tutor</option>
                <option>Virtual Assistant</option><option>IT Support</option><option>Laborer</option>
              </select>
            </div>
            <div class="input"><input id="skillCustom" placeholder="Type custom skill then Add"></div>
            <button type="button" id="addSkillBtn" class="btn" style="width:auto; padding:10px 16px">Add</button>
          </div>
          <div class="hint" style="margin-top:6px">Click ★ on a chip to set your <b>Primary Skill</b>.</div>
          <div id="skillsChips" class="chips" style="margin-top:10px;"></div>
        </div>
        <div>
          <label for="experience">Experience (years)</label>
          <div class="input"><input type="number" id="experience" min="0" step="1" placeholder="e.g., 3"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="rate">Service Rate</label>
          <div class="input"><input type="text" id="rate" placeholder="₱/hour or package"></div>
        </div>
        <div>
          <label for="availability">Availability</label>
          <div class="input"><input type="text" id="availability" placeholder="e.g., Weekdays 9–5, Weekends on-call"></div>
        </div>
      </div>

      <div>
        <label for="bio">About Me</label>
        <div class="input" style="padding:0">
          <textarea id="bio" rows="4" style="padding:12px 14px" placeholder="Brief background, specialties, tools, achievements…"></textarea>
        </div>
      </div>

      <button type="submit" class="btn">Save Profile</button>
    </form>

    <!-- Docs -->
    <div class="docs" id="docsSection">
      <h3>Upload Documents</h3>
      <p class="hint" style="text-align:center;margin-bottom:14px;">
        Accepted: Images (JPG/PNG/WEBP) or PDF · Max 5 MB · Uploaded via Cloudinary
      </p>

      <!-- Valid ID -->
      <div class="doc-item" data-kind="validId">
        <div class="doc-meta">
          <div class="doc-title">📄 Valid ID <a class="view" target="_blank" rel="noopener" href="#" style="display:none;">View</a></div>
          <div class="doc-note">Gov’t ID (front/back ok; PDF or image).</div>
          <div class="status"></div>
        </div>
        <div class="doc-actions">
          <button class="upload btn" style="width:auto; padding:10px 14px">Upload</button>
        </div>
      </div>

      <!-- Police Clearance -->
      <div class="doc-item" data-kind="policeClearance">
        <div class="doc-meta">
          <div class="doc-title">📄 Police Clearance <a class="view" target="_blank" rel="noopener" href="#" style="display:none;">View</a></div>
          <div class="doc-note">Latest police clearance.</div>
          <div class="status"></div>
        </div>
        <div class="doc-actions">
          <button class="upload btn" style="width:auto; padding:10px 14px">Upload</button>
        </div>
      </div>

      <!-- Barangay Clearance -->
      <div class="doc-item" data-kind="barangayClearance">
        <div class="doc-meta">
          <div class="doc-title">📄 Barangay Clearance <a class="view" target="_blank" rel="noopener" href="#" style="display:none;">View</a></div>
          <div class="doc-note">Recent barangay clearance.</div>
          <div class="status"></div>
        </div>
        <div class="doc-actions">
          <button class="upload btn" style="width:auto; padding:10px 14px">Upload</button>
        </div>
      </div>

      <!-- TESDA Certificate -->
      <div class="doc-item" data-kind="tesdaCertificate">
        <div class="doc-meta">
          <div class="doc-title">📄 TESDA Certificate <a class="view" target="_blank" rel="noopener" href="#" style="display:none;">View</a></div>
          <div class="doc-note">TESDA NC/Certificate related to your skills.</div>
          <div class="status"></div>
        </div>
        <div class="doc-actions">
          <button class="upload btn" style="width:auto; padding:10px 14px">Upload</button>
        </div>
      </div>

      <!-- NBI Clearance -->
      <div class="doc-item" data-kind="nbiClearance">
        <div class="doc-meta">
          <div class="doc-title">📄 NBI Clearance <a class="view" target="_blank" rel="noopener" href="#" style="display:none;">View</a></div>
          <div class="doc-note">Latest NBI clearance.</div>
          <div class="status"></div>
        </div>
        <div class="doc-actions">
          <button class="upload btn" style="width:auto; padding:10px 14px">Upload</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cloudinary Upload Widget -->
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

    // --- Cloudinary config ---
    const CLOUD_NAME = "dutarfbgp";
    const UPLOAD_PRESET = "MyApp_uploads";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCkkVvflDza_lmFmUmsgUQv6iOiMW3y9bc",
      authDomain: "myapp-96865.firebaseapp.com",
      databaseURL: "https://myapp-96865-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "myapp-96865",
      storageBucket: "myapp-96865.firebasestorage.app",
      messagingSenderId: "217431866794",
      appId: "1:217431866794:web:965d02cc01d12ae555ffd3",
      measurementId: "G-1T4M9PE1GD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const form = document.getElementById("profileForm");
    const birthdateInput = document.getElementById('birthdate');
    const ageInput = document.getElementById('age');

    // --------- Skills state & helpers ---------
    let SKILLS = [];
    let PRIMARY = "";

    const skillsChips = document.getElementById('skillsChips');
    const presetSel = document.getElementById('skillPreset');
    const customInp = document.getElementById('skillCustom');
    const addBtn = document.getElementById('addSkillBtn');

    function norm(s){ return (s||"").trim().replace(/\s+/g,' '); }
    function existsSkill(s){ const lc = s.toLowerCase(); return SKILLS.some(x => x.toLowerCase() === lc); }
    function addSkill(s){ const v = norm(s); if (!v || existsSkill(v)) return; SKILLS.push(v); if (!PRIMARY) PRIMARY = v; renderChips(); presetSel.value = ""; customInp.value = ""; }
    function removeSkill(s){ SKILLS = SKILLS.filter(x => x.toLowerCase() !== s.toLowerCase()); if (PRIMARY && PRIMARY.toLowerCase() === s.toLowerCase()) PRIMARY = SKILLS[0] || ""; renderChips(); }
    function setPrimary(s){ if (!existsSkill(s)) return; PRIMARY = s; SKILLS = [s, ...SKILLS.filter(x => x.toLowerCase() !== s.toLowerCase())]; renderChips(); }
    function renderChips(){
      skillsChips.innerHTML = "";
      SKILLS.forEach(skill=>{
        const chip = document.createElement('span');
        const isPrimary = (PRIMARY && PRIMARY.toLowerCase() === skill.toLowerCase());
        chip.className = "chip" + (isPrimary ? " primary" : "");
        chip.innerHTML = `<span class="star" title="Set as primary">★</span>
                          <span class="label">${skill}</span>
                          <span class="x" title="Remove">×</span>`;
        chip.querySelector('.x').onclick = ()=> removeSkill(skill);
        chip.querySelector('.star').onclick = ()=> setPrimary(skill);
        skillsChips.appendChild(chip);
      });
    }
    addBtn.addEventListener('click', ()=>{ if (presetSel.value) addSkill(presetSel.value); else if (customInp.value) addSkill(customInp.value); });
    customInp.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); addBtn.click(); }});
    presetSel.addEventListener('change', ()=>{ if (presetSel.value) addSkill(presetSel.value); });

    // --------- Age auto-compute ---------
    birthdateInput.addEventListener('change', () => {
      const birthdate = new Date(birthdateInput.value);
      if (isNaN(birthdate.getTime())) { ageInput.value = ""; return; }
      const today = new Date();
      let age = today.getFullYear() - birthdate.getFullYear();
      const m = today.getMonth() - birthdate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthdate.getDate())) age--;
      ageInput.value = age;
    });

    // ---------- Cloudinary helpers ----------
    const DOC_FIELDS = {
      validId: 'validIdUrl',
      policeClearance: 'policeClearanceUrl',
      barangayClearance: 'barangayClearanceUrl',
      tesdaCertificate: 'tesdaCertificateUrl',
      nbiClearance: 'nbiClearanceUrl'
    };

    function cloudinaryWidget({folder, resourceType="auto", multiple=false, tags=[]}, onSuccess, onClose){
      const options = {
        cloudName: CLOUD_NAME,
        uploadPreset: UPLOAD_PRESET,
        sources: ["local", "camera", "url"],
        multiple,
        resourceType,            // "auto" to allow images/pdf
        clientAllowedFormats: ["jpg","jpeg","png","webp","pdf"],
        maxFileSize: 5 * 1024 * 1024,
        folder,
        tags,
        showPoweredBy: false,
        cropping: false,
        styles: { palette: { window: "#ffffff", sourceBg: "#ffffff", windowBorder: "#E6EDF2",
          tabIcon: "#0E2A32", menuIcons: "#6B7B84", textDark: "#0E2A32", textLight: "#6B7B84",
          link: "#0E2A32", action: "#FFC107", inProgress: "#FFC107", complete: "#16a34a", error: "#dc2626",
          tooltip: "#3c4043", bgOverlay: "#ffffff" } }
      };
      const widget = window.cloudinary.createUploadWidget(options, (err, res) => {
        if (err) { console.error(err); return; }
        if (res && res.event === "success") onSuccess && onSuccess(res.info);
        if (res && (res.event === "close" || res.event === "abort")) onClose && onClose();
      });
      return widget;
    }

    async function updateDocUrl(userUid, fieldUrl, url, extra = {}){
      const userRef = doc(db, "users", userUid);
      await updateDoc(userRef, { [fieldUrl]: url, ...extra, updatedAt: Date.now() });
    }

    function toHttps(url){ if(!url) return ""; return url.startsWith("http://") ? url.replace("http://","https://") : url; }

    // ---------- Wire UI for each doc row ----------
    function wireDocRow(rowEl, user, data){
      const kind = rowEl.getAttribute('data-kind');
      const field = DOC_FIELDS[kind];
      const view = rowEl.querySelector('.view');
      const statusEl = rowEl.querySelector('.status');
      const btn = rowEl.querySelector('.upload');

      const existingUrl = data?.[field];
      if (existingUrl){ view.href = existingUrl; view.style.display = 'inline'; statusEl.textContent = "Uploaded"; }

      btn.addEventListener('click', ()=>{
        btn.disabled = true; statusEl.textContent = "Opening uploader…";
        const folder = `users/${user.uid}/docs`;
        const widget = cloudinaryWidget({ folder, tags:[kind, user.uid], resourceType:"auto" },
          async (info)=>{
            try{
              const url = info.secure_url;
              view.href = url; view.style.display = 'inline';
              statusEl.textContent = "Uploaded ✔";
              await updateDocUrl(user.uid, field, url, { [`${kind}PublicId`]: info.public_id });
            }catch(e){
              console.error(e); statusEl.textContent = "Failed to save URL";
              alert("Upload OK but failed to save to database.");
            }finally{
              btn.disabled = false;
            }
          },
          ()=>{ btn.disabled = false; if(!view.href) statusEl.textContent = ""; }
        );
        widget.open();
      });
    }

    // --------- Phone helpers (lock +63, accept only 10 digits starting with 9) ---------
    const phone10El = document.getElementById('phone10');
    function onlyDigits(s){ return (s||"").replace(/\D/g,''); }
    function toTenDigitsFromAny(phone){
      const d = onlyDigits(phone);
      if (d.startsWith('63') && d.length >= 12) return d.slice(2,12);        // +63XXXXXXXXXX
      if (d.startsWith('0') && d.length >= 11)  return d.slice(1,11);        // 09XXXXXXXXX
      if (d.length === 10) return d;
      return "";
    }
    function isValidPH10(s){ return /^9\d{9}$/.test(s); }

    phone10El.addEventListener('input', ()=>{
      // keep digits only & max 10
      const digits = onlyDigits(phone10El.value).slice(0,10);
      phone10El.value = digits;
    });
    phone10El.addEventListener('blur', ()=>{
      const v = phone10El.value.trim();
      if (v && !isValidPH10(v)) {
        alert("Please enter a valid PH mobile: 10 digits starting with 9 (e.g., 9XXXXXXXXX).");
        phone10El.focus();
      }
    });

    // --------- Prefill + Save (USERS collection) ---------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Please log in first.");
        window.location.href = "login.html";
        return;
      }

      const userRef = doc(db, "users", user.uid);
      let snap = await getDoc(userRef);

      if (snap.exists()) {
        const data = snap.data();

        document.getElementById("fullname").value = data.fullName || data.displayName || "";
        document.getElementById("birthdate").value = data.birthdate || "";
        document.getElementById("gender").value = data.gender || "Male";
        document.getElementById("status").value = data.status || "Single";
        document.getElementById("email").value = (data.email || user.email || "").toLowerCase();
        document.getElementById("location").value = data.location || "";

        // phone prefill → 10-digit field
        const ten = toTenDigitsFromAny(data.phone || "");
        phone10El.value = ten;

        const loadedSkills = Array.isArray(data.skills) ? data.skills.filter(Boolean) : [];
        const primaryFromDoc = data.primarySkill || data.skillCategory || (loadedSkills[0] || "");
        SKILLS = [...new Set(loadedSkills.map(norm))];
        PRIMARY = primaryFromDoc || (SKILLS[0] || "");
        renderChips();

        document.getElementById("experience").value = data.experience ?? "";
        document.getElementById("rate").value = data.pricing || "";
        document.getElementById("availability").value = data.availability || "";
        document.getElementById("bio").value = data.bio || "";

        const purl = data.profileImageUrl || data.photoURL || "";
        if (purl) document.getElementById("profileImage").src = toHttps(purl);

        birthdateInput.dispatchEvent(new Event('change'));

        // Wire document rows
        document.querySelectorAll('.doc-item').forEach(row => wireDocRow(row, user, data));
      } else {
        await setDoc(userRef, { uid: user.uid, email: (user.email || "").toLowerCase(), createdAt: Date.now() }, { merge: true });
        document.getElementById("email").value = (user.email || "").toLowerCase();
        document.querySelectorAll('.doc-item').forEach(row => wireDocRow(row, user, {}));
      }

      // Profile photo upload via Cloudinary widget
      const btnUploadPhoto = document.getElementById('btnUploadPhoto');
      btnUploadPhoto.addEventListener('click', ()=>{
        btnUploadPhoto.disabled = true;
        const folder = `users/${user.uid}/profile`;
        const widget = cloudinaryWidget({ folder, tags:["profile", user.uid], resourceType:"image" },
          async (info)=>{
            try{
              const url = info.secure_url;
              document.getElementById('profileImage').src = toHttps(url);
              await updateDocUrl(user.uid, "profileImageUrl", url, { profileImagePublicId: info.public_id });
            }catch(e){
              console.error(e);
              alert("Uploaded but failed to save profile photo to database.");
            }finally{
              btnUploadPhoto.disabled = false;
            }
          },
          ()=>{ btnUploadPhoto.disabled = false; }
        );
        widget.open();
      });

      // Local preview (optional)
      document.getElementById('photoUpload').addEventListener('change', (e)=>{
        const f = e.target.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = (ev)=> { document.getElementById('profileImage').src = ev.target.result; };
        reader.readAsDataURL(f);
      });

      // Save profile → USERS collection
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // phone validation
        const ten = onlyDigits(phone10El.value).slice(0,10);
        if (!isValidPH10(ten)) {
          alert("Please enter a valid PH mobile: 10 digits starting with 9 (e.g., 9XXXXXXXXX).");
          phone10El.focus();
          return;
        }
        const fullPhone = `+63${ten}`;

        if (!PRIMARY && SKILLS.length) PRIMARY = SKILLS[0];

        const prevSnap = await getDoc(userRef);
        const prev = prevSnap.exists() ? prevSnap.data() : {};

        const payload = {
          uid: user.uid,
          email: document.getElementById("email").value,
          fullName: document.getElementById("fullname").value,
          displayName: document.getElementById("fullname").value || prev.displayName || "",
          birthdate: document.getElementById("birthdate").value,
          age: Number(document.getElementById("age").value) || 0,
          gender: document.getElementById("gender").value,
          status: document.getElementById("status").value,
          phone: fullPhone,                       // ← saved as +63XXXXXXXXXX
          location: document.getElementById("location").value,

          primarySkill: PRIMARY || "",
          skillCategory: PRIMARY || "",           // keep for backward-compat
          skills: SKILLS,

          experience: Number(document.getElementById("experience").value) || 0,
          pricing: document.getElementById("rate").value,
          availability: document.getElementById("availability").value,
          bio: document.getElementById("bio").value,

          profileImageUrl: toHttps(document.getElementById("profileImage").src),

          roles: Array.isArray(prev.roles) ? prev.roles : (prev.roles ? [prev.roles] : []),
          banned: prev.banned ?? false,
          isAdmin: prev.isAdmin ?? false,
          online: true,
          createdAt: prev.createdAt || Date.now(),
          geo: prev.geo ?? { lat: prev.latitude ?? null, lng: prev.longitude ?? null },
          updatedAt: Date.now()
        };

        try {
          await setDoc(userRef, payload, { merge: true });
          alert("Profile saved successfully!");
          window.location.href = "profile_view.html";
        } catch (err) {
          console.error("Failed to save profile:", err);
          alert("Failed to save. Please try again.");
        }
      });
    });
  </script>
</body>
</html>
