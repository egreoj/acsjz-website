<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Beehire — Edit Profile</title>

  <!-- Corporate font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#FFC107;           /* honey gold */
      --ink:#0E2A32;             /* deep navy */
      --muted:#6B7B84;
      --bg:#F6F9FC;              /* soft gray-blue */
      --card:#ffffff;
      --line:#E6EDF2;
      --line-strong:#D7E1EA;
      --focus:#2C7BE5;
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink); background:linear-gradient(180deg,#fff 0%, var(--bg) 70%);
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:40;
      background:var(--card); border-bottom:1px solid var(--line);
      box-shadow:0 2px 10px rgba(14,42,50,.04);
    }
    .nav{
      max-width:1100px; margin:0 auto; padding:14px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:12px; text-decoration:none}
    .brand-logo{width:42px; height:42px; object-fit:contain; filter:drop-shadow(0 2px 8px rgba(0,0,0,.06))}
    .brand-title{display:flex; flex-direction:column; line-height:1.1}
    .brand-title .name{font-weight:800; font-size:1.12rem; color:var(--ink)}
    .brand-title .tag{font-size:.8rem; color:var(--muted); font-weight:700; letter-spacing:.3px}
    .badge{
      padding:6px 10px; border:1px solid var(--line-strong); border-radius:999px; color:var(--ink);
      font-size:.8rem; font-weight:800; background:#fff;
    }

    /* Container */
    .container{
      max-width:1100px; background:var(--card);
      margin:26px auto 34px; padding:26px; border-radius:18px;
      border:1px solid var(--line);
      box-shadow:0 12px 28px rgba(14,42,50,.08);
    }
    h2{
      margin:0 0 18px; text-align:center; color:var(--ink); font-size:1.35rem; letter-spacing:.2px;
    }

    form{display:flex; flex-direction:column; gap:20px}
    label{font-weight:800; margin-bottom:6px; font-size:.95rem}

    .row{display:flex; gap:18px; flex-wrap:wrap}
    .row > div{flex:1; min-width:260px}

    .input{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line); border-radius:12px; padding:12px 14px;
      background:#fff; transition:border-color .15s, box-shadow .15s;
    }
    .input:focus-within{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(44,123,229,.15) }
    .input input, .input select, .input textarea{
      outline:none; border:0; width:100%; font-size:1rem; background:transparent; color:var(--ink);
    }
    textarea{resize:vertical}

    /* Profile photo */
    .profile-photo{
      text-align:center; display:grid; place-items:center; gap:10px;
    }
    .profile-photo img{
      width:150px; height:150px; border-radius:50%; object-fit:cover;
      border:5px solid var(--brand); background:#fff;
      box-shadow:0 6px 16px rgba(14,42,50,.08);
    }

    /* Skills editor */
    .skills-editor{
      display:grid; grid-template-columns: 1.1fr 1.2fr auto; gap:10px; align-items:center;
    }
    @media (max-width: 720px){ .skills-editor{ grid-template-columns:1fr } }
    .chips{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid var(--line-strong); color:#111;
      padding:6px 10px; border-radius:999px; box-shadow:0 1px 2px rgba(0,0,0,.04);
      font-weight:700; font-size:.9rem;
    }
    .chip .x{ cursor:pointer; font-weight:800 }
    .chip .star{ cursor:pointer; filter:grayscale(1) }
    .chip.primary{ border-color:#F3D66A; background:#FFF6D6 }
    .chip.primary .star{ filter:grayscale(0) }
    .hint{ font-size:.9rem; color:var(--muted) }

    /* Buttons */
    .btn{
      background:var(--brand); color:#111; padding:14px 16px;
      border:0; border-radius:12px; font-size:1rem; font-weight:800; cursor:pointer;
      align-self:center; width:220px;
      box-shadow:0 8px 20px rgba(255,193,7,.28);
      transition:transform .06s, box-shadow .15s, filter .15s;
    }
    .btn:hover{ filter:brightness(.98); box-shadow:0 12px 26px rgba(255,193,7,.38) }
    .btn:active{ transform:translateY(1px) }

    /* Docs */
    .docs{ margin-top:28px; border-top:1px dashed var(--line-strong); padding-top:18px }
    .docs h3{ margin:0 0 12px; text-align:center; font-size:1.1rem }
    .doc-item{
      display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; margin-bottom:12px;
      background:#fbfdff; border:1px solid var(--line); border-radius:12px; padding:12px;
    }
    .doc-meta{ display:flex; flex-direction:column; gap:8px }
    .doc-title{ font-weight:800; color:#222; display:flex; align-items:center; gap:8px }
    .doc-actions{ display:flex; gap:8px; align-items:center }
    .doc-actions a{ text-decoration:none; color:#0D6EFD; font-weight:800 }
    .doc-note{ font-size:.9rem; color:var(--muted) }
    .prog{ width:160px; height:10px }
    .danger{ background:#dc2626; color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer }
    .danger:hover{ filter:brightness(.95) }

    /* Small icons in inputs (optional) */
    .ico{flex:0 0 18px; opacity:.7}

    /* Focus ring for buttons/links */
    button:focus, a:focus{ outline:none; box-shadow:0 0 0 3px rgba(44,123,229,.2) }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="nav">
      <a class="brand" href="beehiremain.html">
        <img class="brand-logo" src="BeeHire Logo.png" alt="Beehire logo">
        <span class="brand-title">
          <span class="name">Beehire CONNECT</span>
          <span class="tag">Edit Profile</span>
        </span>
      </a>
      <span class="badge">Worker Portal</span>
    </div>
  </header>

  <div class="container">
    <h2>Edit Your Profile</h2>

    <form id="profileForm" novalidate>
      <!-- Photo -->
      <div class="profile-photo">
        <img id="profileImage" src="https://via.placeholder.com/150" alt="Profile Photo">
        <div class="input" style="width:min(420px,100%)">
          <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M9 2l1.5 2H14l1.5-2H18l2 3h2v15a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5h2l2-3h3Zm3 16a5 5 0 1 0 0-10a5 5 0 0 0 0 10Zm0-2a3 3 0 1 1 0-6a3 3 0 0 1 0 6Z"/></svg>
          <input type="file" id="photoUpload" accept="image/*">
        </div>
      </div>

      <!-- Identity -->
      <div class="row">
        <div>
          <label for="fullname">Full Name</label>
          <div class="input"><input type="text" id="fullname" placeholder="Juan D. Dela Cruz"></div>
        </div>
        <div>
          <label for="birthdate">Birthdate</label>
          <div class="input"><input type="date" id="birthdate"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="age">Age</label>
          <div class="input"><input type="number" id="age" readonly></div>
        </div>
        <div>
          <label for="gender">Gender</label>
          <div class="input">
            <select id="gender">
              <option>Male</option><option>Female</option><option>Other</option>
            </select>
          </div>
        </div>
        <div>
          <label for="status">Civil Status</label>
          <div class="input">
            <select id="status">
              <option>Single</option><option>Married</option><option>Separated</option><option>Widowed</option>
            </select>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="phone">Phone Number</label>
          <div class="input"><input type="tel" id="phone" placeholder="+63 9xx xxx xxxx"></div>
        </div>
        <div>
          <label for="email">Email Address</label>
          <div class="input"><input type="email" id="email" readonly></div>
        </div>
        <div>
          <label for="location">Location</label>
          <div class="input"><input type="text" id="location" placeholder="City, Province"></div>
        </div>
      </div>

      <!-- Skills -->
      <div class="row">
        <div style="flex:2">
          <label>Skills (choose multiple or add custom)</label>
          <div class="skills-editor">
            <div class="input">
              <select id="skillPreset" aria-label="Skill preset">
                <option value="">Select preset…</option>
                <option>Electrician</option><option>Plumber</option><option>Carpenter</option>
                <option>Mechanic</option><option>Cleaner</option><option>Driver</option>
                <option>Painter</option><option>Cook</option><option>Tutor</option>
                <option>Virtual Assistant</option><option>IT Support</option><option>Laborer</option>
              </select>
            </div>
            <div class="input"><input id="skillCustom" placeholder="Type custom skill then Add"></div>
            <button type="button" id="addSkillBtn" class="btn" style="width:auto; padding:10px 16px">Add</button>
          </div>
          <div class="hint" style="margin-top:6px">Tip: Click the ★ on a chip to set your <b>Primary Skill</b>.</div>
          <div id="skillsChips" class="chips" style="margin-top:10px;"></div>
        </div>
        <div>
          <label for="experience">Experience (years)</label>
          <div class="input"><input type="number" id="experience" min="0" step="1" placeholder="e.g., 3"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="rate">Service Rate</label>
          <div class="input"><input type="text" id="rate" placeholder="₱/hour or package"></div>
        </div>
        <div>
          <label for="availability">Availability</label>
          <div class="input"><input type="text" id="availability" placeholder="e.g., Weekdays 9–5, Weekends on-call"></div>
        </div>
      </div>

      <div>
        <label for="bio">About Me</label>
        <div class="input" style="padding:0">
          <textarea id="bio" rows="4" style="padding:12px 14px" placeholder="Brief background, specialties, tools, achievements…"></textarea>
        </div>
      </div>

      <button type="submit" class="btn">Save Profile</button>
    </form>

    <!-- Docs -->
    <div class="docs" id="docsSection">
      <h3>Upload Documents</h3>
      <p class="hint" style="text-align:center;margin-bottom:14px;">
        Accepted: Images (JPG/PNG/WEBP) or PDF · Images auto-compressed ≤ 500 KB · Max raw 5 MB
      </p>

      <!-- Valid ID -->
      <div class="doc-item" data-kind="validId">
        <div class="doc-meta">
          <div class="doc-title">📄 Valid ID <a class="view" target="_blank" rel="noopener" href="#" style="display:none;">View</a></div>
          <input type="file" accept="image/*,application/pdf" class="file">
          <div class="doc-note">Gov’t ID (best quality). If front/back separate, i-merge sa PDF kung possible.</div>
        </div>
        <div class="doc-actions">
          <progress class="prog" value="0" max="100"></progress>
          <button class="upload btn" style="width:auto; padding:10px 14px">Upload</button>
          <button class="delete danger" style="display:none;">Delete</button>
        </div>
      </div>

      <!-- Police Clearance -->
      <div class="doc-item" data-kind="policeClearance">
        <div class="doc-meta">
          <div class="doc-title">📄 Police Clearance <a class="view" target="_blank" rel="noopener" href="#" style="display:none;">View</a></div>
          <input type="file" accept="image/*,application/pdf" class="file">
          <div class="doc-note">Latest police clearance.</div>
        </div>
        <div class="doc-actions">
          <progress class="prog" value="0" max="100"></progress>
          <button class="upload btn" style="width:auto; padding:10px 14px">Upload</button>
          <button class="delete danger" style="display:none;">Delete</button>
        </div>
      </div>

      <!-- Barangay Clearance -->
      <div class="doc-item" data-kind="barangayClearance">
        <div class="doc-meta">
          <div class="doc-title">📄 Barangay Clearance <a class="view" target="_blank" rel="noopener" href="#" style="display:none;">View</a></div>
          <input type="file" accept="image/*,application/pdf" class="file">
          <div class="doc-note">Recent barangay clearance.</div>
        </div>
        <div class="doc-actions">
          <progress class="prog" value="0" max="100"></progress>
          <button class="upload btn" style="width:auto; padding:10px 14px">Upload</button>
          <button class="delete danger" style="display:none;">Delete</button>
        </div>
      </div>

      <!-- TESDA Certificate -->
      <div class="doc-item" data-kind="tesdaCertificate">
        <div class="doc-meta">
          <div class="doc-title">📄 TESDA Certificate <a class="view" target="_blank" rel="noopener" href="#" style="display:none;">View</a></div>
          <input type="file" accept="image/*,application/pdf" class="file">
          <div class="doc-note">TESDA NC/Certificate related to your skills.</div>
        </div>
        <div class="doc-actions">
          <progress class="prog" value="0" max="100"></progress>
          <button class="upload btn" style="width:auto; padding:10px 14px">Upload</button>
          <button class="delete danger" style="display:none;">Delete</button>
        </div>
      </div>

      <!-- NBI Clearance -->
      <div class="doc-item" data-kind="nbiClearance">
        <div class="doc-meta">
          <div class="doc-title">📄 NBI Clearance <a class="view" target="_blank" rel="noopener" href="#" style="display:none;">View</a></div>
          <input type="file" accept="image/*,application/pdf" class="file">
          <div class="doc-note">Latest NBI clearance.</div>
        </div>
        <div class="doc-actions">
          <progress class="prog" value="0" max="100"></progress>
          <button class="upload btn" style="width:auto; padding:10px 14px">Upload</button>
          <button class="delete danger" style="display:none;">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkkVvflDza_lmFmUmsgUQv6iOiMW3y9bc",
        authDomain: "myapp-96865.firebaseapp.com",
        databaseURL: "https://myapp-96865-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "myapp-96865",
        // If Storage misbehaves, try: "myapp-96865.appspot.com"
        storageBucket: "myapp-96865.firebasestorage.app",
        messagingSenderId: "217431866794",
        appId: "1:217431866794:web:965d02cc01d12ae555ffd3",
        measurementId: "G-1T4M9PE1GD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const form = document.getElementById("profileForm");
    const birthdateInput = document.getElementById('birthdate');
    const ageInput = document.getElementById('age');

    // --------- Skills state & helpers ---------
    let SKILLS = [];
    let PRIMARY = "";

    const skillsChips = document.getElementById('skillsChips');
    const presetSel = document.getElementById('skillPreset');
    const customInp = document.getElementById('skillCustom');
    const addBtn = document.getElementById('addSkillBtn');

    function norm(s){ return (s||"").trim().replace(/\s+/g,' '); }
    function existsSkill(s){ const lc = s.toLowerCase(); return SKILLS.some(x => x.toLowerCase() === lc); }
    function addSkill(s){ const v = norm(s); if (!v || existsSkill(v)) return; SKILLS.push(v); if (!PRIMARY) PRIMARY = v; renderChips(); presetSel.value = ""; customInp.value = ""; }
    function removeSkill(s){ SKILLS = SKILLS.filter(x => x.toLowerCase() !== s.toLowerCase()); if (PRIMARY && PRIMARY.toLowerCase() === s.toLowerCase()) PRIMARY = SKILLS[0] || ""; renderChips(); }
    function setPrimary(s){ if (!existsSkill(s)) return; PRIMARY = s; SKILLS = [s, ...SKILLS.filter(x => x.toLowerCase() !== s.toLowerCase())]; renderChips(); }
    function renderChips(){
      skillsChips.innerHTML = "";
      SKILLS.forEach(skill=>{
        const chip = document.createElement('span');
        const isPrimary = (PRIMARY && PRIMARY.toLowerCase() === skill.toLowerCase());
        chip.className = "chip" + (isPrimary ? " primary" : "");
        chip.innerHTML = `<span class="star" title="Set as primary">★</span>
                          <span class="label">${skill}</span>
                          <span class="x" title="Remove">×</span>`;
        chip.querySelector('.x').onclick = ()=> removeSkill(skill);
        chip.querySelector('.star').onclick = ()=> setPrimary(skill);
        skillsChips.appendChild(chip);
      });
    }
    addBtn.addEventListener('click', ()=>{ if (presetSel.value) addSkill(presetSel.value); else if (customInp.value) addSkill(customInp.value); });
    customInp.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); addBtn.click(); }});
    presetSel.addEventListener('change', ()=>{ if (presetSel.value) addSkill(presetSel.value); });

    // --------- Age auto-compute ---------
    birthdateInput.addEventListener('change', () => {
      const birthdate = new Date(birthdateInput.value);
      if (isNaN(birthdate.getTime())) { ageInput.value = ""; return; }
      const today = new Date();
      let age = today.getFullYear() - birthdate.getFullYear();
      const m = today.getMonth() - birthdate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthdate.getDate())) age--;
      ageInput.value = age;
    });

    // ---------- Docs helpers ----------
    const DOC_FIELDS = {
      validId: 'validIdUrl',
      policeClearance: 'policeClearanceUrl',
      barangayClearance: 'barangayClearanceUrl',
      tesdaCertificate: 'tesdaCertificateUrl',
      nbiClearance: 'nbiClearanceUrl'
    };

    function extOf(name){ const m = (name||'').match(/\.([a-z0-9]+)$/i); return m ? m[1].toLowerCase() : 'bin'; }
    function isAllowedType(file){
      if (!file) return false;
      const t = file.type;
      return t.startsWith('image/') || t === 'application/pdf';
    }

    // Image compression to ≤ 500KB
    async function compressImageFile(file, targetBytes = 500 * 1024) {
      const img = await new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const i = new Image();
        i.onload = () => { URL.revokeObjectURL(url); resolve(i); };
        i.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
        i.src = url;
      });

      let maxW = 1600, maxH = 1600;
      let quality = 0.85;

      async function renderBlob(scale=1.0) {
        const w = Math.min(img.width, Math.round(img.width * scale), maxW);
        const h = Math.min(img.height, Math.round(img.height * scale), maxH);
        const canvas = document.createElement('canvas');
        const ratio = Math.min(w / img.width, h / img.height);
        canvas.width = Math.max(1, Math.round(img.width * ratio));
        canvas.height = Math.max(1, Math.round(img.height * ratio));
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
        return blob;
      }

      let scale = 1.0;
      let blob = await renderBlob(scale);
      let tries = 0;
      while (blob && blob.size > targetBytes && tries < 10) {
        if (quality > 0.55) quality -= 0.08; else scale *= 0.9;
        blob = await renderBlob(scale);
        tries++;
      }

      const finalBlob = blob || file;
      return new File([finalBlob], (file.name.replace(/\.[^.]+$/,'') || 'image') + '.jpg', { type: 'image/jpeg' });
    }

    async function uploadDoc(user, kind, file, ui, existingPath){
      if (!file){ alert("Please select a file."); return; }
      if (!isAllowedType(file)){ alert("File must be an image or PDF."); return; }
      if (file.size > 5 * 1024 * 1024){ alert("Max 5 MB per file."); return; }

      let uploadFile = file;
      let ext = extOf(file.name);
      let contentType = file.type;
      if (file.type.startsWith('image/')) {
        uploadFile = await compressImageFile(file, 500 * 1024);
        ext = 'jpg'; contentType = 'image/jpeg';
      }

      const path = `workers/${user.uid}/docs/${kind}-${Date.now()}.${ext}`;
      const storageRef = ref(storage, path);
      const task = uploadBytesResumable(storageRef, uploadFile, { contentType });

      ui.prog.value = 0; ui.prog.style.opacity = 1; ui.upload.disabled = true;

      return new Promise((resolve,reject)=>{
        task.on('state_changed',
          (snap)=>{
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            ui.prog.value = pct;
          },
          (err)=>{
            console.error(err); ui.upload.disabled = false; reject(err);
          },
          async ()=>{
            try{
              const url = await getDownloadURL(task.snapshot.ref);

              // delete old file if present
              if (existingPath){
                try { await deleteObject(ref(storage, existingPath)); } catch(e){ /* ignore */ }
              }

              const userRef = doc(db, "workers", user.uid);
              const field = DOC_FIELDS[kind];
              const dataToUpdate = {};
              dataToUpdate[field] = url;
              dataToUpdate[field.replace(/Url$/,'Path')] = path;
              await updateDoc(userRef, dataToUpdate);

              ui.view.href = url; ui.view.style.display = 'inline';
              ui.del.style.display = 'inline-block';
              ui.upload.disabled = false; ui.prog.style.opacity = 0.6;
              resolve(url);
            }catch(e){
              ui.upload.disabled = false;
              reject(e);
            }
          }
        );
      });
    }

    async function deleteDoc(user, kind, ui, docSnap){
      const field = DOC_FIELDS[kind];
      const pathField = field.replace(/Url$/,'Path');
      const data = docSnap?.data?.() || docSnap?.data() || {};
      const existingPath = data[pathField];
      const existingUrl = data[field];

      if (!existingPath && !existingUrl){ alert("No document to delete."); return; }
      if (!confirm("Delete this document? This cannot be undone.")) return;

      try { if (existingPath) await deleteObject(ref(storage, existingPath)); } catch(_) {}
      const userRef = doc(db, "workers", user.uid);
      await updateDoc(userRef, { [field]: deleteField(), [pathField]: deleteField() });

      ui.view.style.display = 'none'; ui.view.removeAttribute('href');
      ui.file.value = ''; ui.prog.value = 0; ui.del.style.display = 'none';
      alert("Deleted.");
    }

    function wireDocRow(rowEl, user, docSnap){
      const kind = rowEl.getAttribute('data-kind');
      const fileEl = rowEl.querySelector('.file');
      const btn = rowEl.querySelector('.upload');
      const prog = rowEl.querySelector('.prog');
      const view = rowEl.querySelector('.view');
      const delBtn = rowEl.querySelector('.delete');

      const field = DOC_FIELDS[kind];
      const pathField = field.replace(/Url$/,'Path');
      const data = docSnap?.data?.() || docSnap?.data() || {};
      const existingUrl = data[field] || null;

      if (existingUrl){
        view.href = existingUrl.startsWith('http://') ? existingUrl.replace('http://','https://') : existingUrl;
        view.style.display = 'inline';
        delBtn.style.display = 'inline-block';
      }

      btn.addEventListener('click', async ()=>{
        if (!auth.currentUser){ alert("Please log in first."); return; }
        const latestSnap = await getDoc(doc(db, "workers", user.uid));
        const existingPath = (latestSnap.data() || {})[pathField] || null;
        try{
          await uploadDoc(user, kind, fileEl.files?.[0], { prog, upload: btn, view, del: delBtn, file: fileEl }, existingPath);
          alert("Uploaded!");
        }catch(e){
          alert("Upload failed: " + (e?.message || e));
        }
      });

      delBtn.addEventListener('click', async ()=>{
        if (!auth.currentUser){ alert("Please log in first."); return; }
        const latestSnap = await getDoc(doc(db, "workers", user.uid));
        await deleteDoc(user, kind, { view, del: delBtn, file: fileEl, prog }, latestSnap);
      });
    }

    // Prefill + save
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Please log in first.");
        window.location.href = "login.html";
        return;
      }

      const userRef = doc(db, "workers", user.uid);
      let docSnap = await getDoc(userRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById("fullname").value = data.fullName || "";
        document.getElementById("birthdate").value = data.birthdate || "";
        document.getElementById("gender").value = data.gender || "Male";
        document.getElementById("status").value = data.status || "Single";
        document.getElementById("phone").value = data.phone || "";
        document.getElementById("email").value = data.email || user.email;
        document.getElementById("location").value = data.location || "";

        const loadedSkills = Array.isArray(data.skills) ? data.skills.filter(Boolean) : [];
        const primaryFromDoc = data.skillCategory || (loadedSkills[0] || "");
        SKILLS = [...new Set(loadedSkills.map(norm))];
        PRIMARY = primaryFromDoc || (SKILLS[0] || "");
        renderChips();

        document.getElementById("experience").value = data.experience ?? "";
        document.getElementById("rate").value = data.pricing || "";
        document.getElementById("availability").value = data.availability || "";
        document.getElementById("bio").value = data.bio || "";
        if (data.profileImageUrl) {
          document.getElementById("profileImage").src = data.profileImageUrl.startsWith("http://")
            ? data.profileImageUrl.replace("http://","https://")
            : data.profileImageUrl;
        }
        birthdateInput.dispatchEvent(new Event('change'));
      } else {
        await setDoc(userRef, { uid: user.uid, email: user.email, createdAt: Date.now() }, { merge: true });
        document.getElementById("email").value = user.email;
        docSnap = await getDoc(userRef);
      }

      // Wire docs after we have (possibly) initialized the record
      document.querySelectorAll('.doc-item').forEach(row => wireDocRow(row, user, docSnap));

      // Save profile
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const securePhotoUrl = document.getElementById("profileImage").src.startsWith("http://")
          ? document.getElementById("profileImage").src.replace("http://", "https://")
          : document.getElementById("profileImage").src;

        if (!PRIMARY && SKILLS.length) PRIMARY = SKILLS[0];

        const snapshot = await getDoc(userRef);
        const prev = snapshot.exists() ? snapshot.data() : {};

        const userData = {
          uid: user.uid,
          email: document.getElementById("email").value,
          fullName: document.getElementById("fullname").value,
          birthdate: document.getElementById("birthdate").value,
          age: Number(document.getElementById("age").value) || 0,
          gender: document.getElementById("gender").value,
          status: document.getElementById("status").value,
          phone: document.getElementById("phone").value,
          location: document.getElementById("location").value,

          skillCategory: PRIMARY || "",
          skills: SKILLS,

          experience: Number(document.getElementById("experience").value) || 0,
          pricing: document.getElementById("rate").value,
          serviceRadius: prev.serviceRadius || "100",
          availability: document.getElementById("availability").value,
          bio: document.getElementById("bio").value,
          profileImageUrl: securePhotoUrl,
          banned: prev.banned ?? false,
          isAdmin: prev.isAdmin ?? false,
          online: true,
          createdAt: prev.createdAt || Date.now(),
          latitude: prev.latitude ?? null,
          longitude: prev.longitude ?? null,
          updatedAt: Date.now()
        };

        try {
          await setDoc(userRef, userData, { merge: true });
          alert("Profile saved successfully!");
          window.location.href = "beehiremain.html";
        } catch (err) {
          console.error("Failed to save profile:", err);
          alert("Failed to save. Please try again.");
        }
      });
    });

    // Local preview of selected photo
    document.getElementById('photoUpload').addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (ev)=> { document.getElementById('profileImage').src = ev.target.result; };
      reader.readAsDataURL(f);
    });
  </script>
</body>
</html>
